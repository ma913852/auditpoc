<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura GxP - Definitive Interactive Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .main-tab.active { border-bottom-color: #0D47A1; color: #0D47A1; font-weight: 600; }
        .main-tab { border-bottom: 4px solid transparent; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-complete { background-color: #10B981; }
        .status-pending { background-color: #F59E0B; }
        .status-analyzing { background-color: #3B82F6; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .active-agenda { background-color: #0D47A1; color: white; border-left-color: #81D4FA; }
        .active-sub-agenda { background-color: #E0F7FA; color: #0D47A1; font-weight: 600; }
        .grade-btn.selected { transform: scale(1.05); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.5); }
        .focus-area-card { cursor: pointer; transition: all 0.2s; }
        .focus-area-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .focus-area-card.critical { border-left: 4px solid #EF4444; }
        .focus-area-card.high { border-left: 4px solid #F59E0B; }
        .focus-area-card.medium { border-left: 4px solid #3B82F6; }
        .filter-btn-active { background-color: #1e293b !important; color: white !important; }
        .focus-area-details { display: none; }
        .focus-area-card.expanded .focus-area-details { display: block; }
        .editable-field[contenteditable="true"] { 
            cursor: text; 
            min-height: 30px;
            transition: all 0.2s;
        }
        .editable-field[contenteditable="true"]:focus { 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .group:hover img {
            transform: scale(1.02);
            transition: transform 0.2s;
        }
        .recording { animation: pulse-red 1.5s ease-in-out infinite; }
            @keyframes pulse-red {
                0%, 100% { background-color: #DC2626; }
                50% { background-color: #EF4444; }
            }
            .ai-suggestion {
                animation: fadeIn 0.5s ease-in;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
    </style>
</head>
<body class="text-slate-800">

    <div class="w-[80%] h-full mx-auto md:my-2 md:rounded-2xl shadow-2xl bg-slate-200 p-2 overflow-hidden">
        <div class="bg-white rounded-xl overflow-hidden">
            <header class="bg-white p-4 flex justify-between items-center border-b border-slate-200">
                <div>
                    <h1 class="font-bold text-xl text-[#0D47A1]">Audit: PharmaCore Aseptic Filling, Site C</h1>
                    <p class="text-sm text-slate-500">ID: AUD-2025-045 | Status: <span id="auditStatus">Pre-Audit</span></p>
                </div>
                <button class="bg-red-500 text-white font-bold px-4 py-2 rounded-lg text-lg" onclick="openCaptureModal()" title="Add New Observation">+</button>
            </header>
            
            <nav class="flex border-b border-slate-200 bg-slate-50">
                <button onclick="switchTab('prep')" id="tab-prep" class="main-tab active flex-1 py-4 px-6 text-slate-600 text-center transition-colors duration-200">1. Pre-Audit Prep</button>
                <button onclick="switchTab('fieldwork')" id="tab-fieldwork" class="main-tab flex-1 py-4 px-6 text-slate-600 text-center transition-colors duration-200">2. Live Fieldwork</button>
                <button onclick="switchTab('finalization')" id="tab-finalization" class="main-tab flex-1 py-4 px-6 text-slate-600 text-center transition-colors duration-200">3. Finalization & Reporting</button>
            </nav>

            <main id="main-content" class="h-[90vh] overflow-y-auto">
                <!-- PRE-AUDIT PREP TAB -->
                <div id="prep-content" class="p-6">
                    <h2 class="font-bold text-xl text-[#0D47A1] mb-6">Pre-Audit Document Request & Analysis</h2>
                    
                    <!-- Audit Scope and Standards Section -->
                    <div id="scopeStandardsSection" class="bg-gradient-to-br from-blue-50 to-slate-50 border-2 border-blue-200 rounded-lg p-6 mb-6 shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-[#0D47A1] mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <h3 class="font-bold text-xl text-[#0D47A1]">Audit Scope & Standards</h3>
                            </div>
                            <button id="editScopeBtn" onclick="toggleScopeEdit()" class="bg-slate-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-slate-700 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Audit Scope -->
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="font-bold text-md text-[#0D47A1] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    Audit Scope
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div>
                                        <span class="font-semibold text-slate-700">Facility:</span>
                                        <p id="facility" class="text-slate-600 mt-1 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">PharmaCore Manufacturing Site C - Aseptic Filling Suite 2</p>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-slate-700">Process Areas:</span>
                                        <ul id="processAreas" class="list-disc list-inside text-slate-600 mt-1 ml-2 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">
                                            <li>Grade A/B Aseptic Filling Operations</li>
                                            <li>Environmental Monitoring Program</li>
                                            <li>Sterilization & Depyrogenation Processes</li>
                                            <li>Gowning & Personnel Training</li>
                                            <li>Media Fill Validation Studies</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-slate-700">Products in Scope:</span>
                                        <p id="products" class="text-slate-600 mt-1 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">Injectable biologics (monoclonal antibodies) - Products XYZ-101, XYZ-102, XYZ-105</p>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-slate-700">Time Period:</span>
                                        <p id="timePeriod" class="text-slate-600 mt-1 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">January 2024 - December 2024 (12 months)</p>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-slate-700">Key Systems:</span>
                                        <ul id="keySystems" class="list-disc list-inside text-slate-600 mt-1 ml-2 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">
                                            <li>Quality Management System (QMS)</li>
                                            <li>Training Management System</li>
                                            <li>CAPA System</li>
                                            <li>Change Control System</li>
                                            <li>Deviation Management System</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Audit Standards -->
                            <div class="bg-white rounded-lg p-5 shadow-sm">
                                <h4 class="font-bold text-md text-[#0D47A1] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                    Applicable Standards & Regulations
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div>
                                        <span class="font-semibold text-slate-700">Regulatory Requirements:</span>
                                        <ul id="regulatoryReqs" class="list-disc list-inside text-slate-600 mt-1 ml-2 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">
                                            <li>21 CFR Part 211 - cGMP for Finished Pharmaceuticals</li>
                                            <li>21 CFR Part 11 - Electronic Records & Signatures</li>
                                            <li>EU GMP Annex 1 (2022) - Sterile Medicinal Products</li>
                                            <li>ICH Q7 - Good Manufacturing Practice</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-slate-700">Industry Guidelines:</span>
                                        <ul id="industryGuidelines" class="list-disc list-inside text-slate-600 mt-1 ml-2 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">
                                            <li>PDA TR 13 - Fundamentals of an Environmental Monitoring Program</li>
                                            <li>PDA TR 22 - Process Simulation for Aseptically Filled Products</li>
                                            <li>ISO 14644 - Cleanroom Classification</li>
                                            <li>USP <797> - Pharmaceutical Compounding—Sterile Preparations</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-slate-700">Internal Standards:</span>
                                        <ul id="internalStandards" class="list-disc list-inside text-slate-600 mt-1 ml-2 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">
                                            <li>PharmaCore Global Quality Standards v4.2</li>
                                            <li>Aseptic Processing Master Plan 2024</li>
                                            <li>Site C Quality Risk Management Framework</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-slate-700">Audit Type:</span>
                                        <p id="auditType" class="text-slate-600 mt-1 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">Scheduled Quality System Audit (Pre-Approval Inspection Readiness)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audit Objectives -->
                        <div class="mt-4 bg-white rounded-lg p-5 shadow-sm">
                            <h4 class="font-bold text-md text-[#0D47A1] mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                                Audit Objectives
                            </h4>
                            <ul id="auditObjectives" class="list-decimal list-inside text-sm text-slate-600 space-y-2 ml-2 editable-field p-2 rounded hover:bg-slate-50 transition-colors" contenteditable="false">
                                <li>Verify compliance with FDA 21 CFR Part 211 and EU GMP Annex 1 requirements for aseptic processing</li>
                                <li>Assess the effectiveness of contamination control strategy and environmental monitoring program</li>
                                <li>Evaluate personnel training, qualification, and adherence to aseptic techniques</li>
                                <li>Review media fill validation studies and sterility assurance level (SAL) compliance</li>
                                <li>Assess CAPA effectiveness for previous aseptic processing deviations</li>
                                <li>Confirm readiness for upcoming FDA Pre-Approval Inspection (PAI)</li>
                            </ul>
                        </div>
                        
                        <!-- AI-Generated Requirements Section -->
                        <div class="mt-4 bg-gradient-to-br from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-5 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-md text-[#0D47A1] flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                    AI-Generated Compliance Requirements
                                </h4>
                                <button onclick="generateRequirements()" id="generateReqBtn" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-purple-700 hover:to-blue-700 transition-all flex items-center shadow-md">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    Generate Requirements
                                </button>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="reqLoadingState" class="hidden">
                                <div class="flex items-center justify-center py-8">
                                    <div class="text-center">
                                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
                                        <p class="text-purple-700 font-semibold" id="reqLoadingMessage">Analyzing audit scope...</p>
                                        <p class="text-purple-600 text-sm mt-2">Querying Databricks Claude Sonnet 3.5</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="reqEmptyState" class="text-center py-8">
                                <svg class="w-16 h-16 text-purple-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-purple-700 font-semibold mb-2">No requirements generated yet</p>
                                <p class="text-purple-600 text-sm">Click "Generate Requirements" to use AI to identify applicable compliance requirements based on your audit scope</p>
                            </div>
                            
                            <!-- Requirements Display -->
                            <div id="reqDisplayArea" class="hidden">
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <div>
                                            <span class="text-lg font-bold text-purple-700" id="reqTotalCount">0</span>
                                            <span class="text-slate-600 text-sm ml-2">total requirements</span>
                                        </div>
                                        <button onclick="exportRequirements()" class="text-sm text-purple-600 hover:text-purple-800 flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                            </svg>
                                            Export
                                        </button>
                                    </div>
                                    
                                    <!-- Category Tabs -->
                                    <div id="reqCategoryTabs" class="flex gap-2 flex-wrap mb-4"></div>
                                    
                                    <!-- Requirements List -->
                                    <div id="reqList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                                </div>
                            </div>
                            
                            <!-- Error State -->
                            <div id="reqErrorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-red-800 font-medium" id="reqErrorMessage">Error generating requirements</span>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Edit Mode Actions (Hidden by default) -->
                        <div id="scopeEditActions" class="mt-4 flex flex-wrap gap-3 hidden">
                            <button onclick="saveScopeChanges()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Save Changes
                            </button>
                            <button onclick="cancelScopeEdit()" class="bg-slate-400 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-500 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Top Section: Document Requests and Focus Areas -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-inner">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg text-[#0D47A1]">Document Request Status</h3>
                                <button onclick="addDocumentGroup()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors flex items-center shadow-md">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                    Add Category
                                </button>
                            </div>
                            <div id="documentStatusContent" class="space-y-3">
                                <!-- Master Batch Records -->
                                <div class="border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('group-mbr')">
                                        <div class="flex items-center flex-1">
                                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-group-mbr" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        <span class="font-semibold">Master Batch Records</span>
                                    </div>
                                        <span class="text-xs text-slate-500 font-semibold">1 doc</span>
                                    </div>
                                    <div id="group-mbr" class="p-3 bg-white border-t border-slate-200">
                                        <div class="flex gap-2 mb-3">
                                            <input type="file" id="upload-mbr" class="hidden" accept=".pdf,.doc,.docx" onchange="handleDocumentUpload(event, 'Master Batch Records')">
                                            <button onclick="document.getElementById('upload-mbr').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                                Upload
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2" id="thumbnails-mbr">
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/0D47A1/FFFFFF?text=MBR" alt="MBR-FILL-002" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">MBR-FILL-002</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quality System SOPs -->
                                <div class="border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('group-qsops')">
                                        <div class="flex items-center flex-1">
                                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-group-qsops" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        <span class="font-semibold">Quality System SOPs</span>
                                    </div>
                                        <span class="text-xs text-slate-500 font-semibold">2 docs</span>
                                    </div>
                                    <div id="group-qsops" class="p-3 bg-white border-t border-slate-200 hidden">
                                        <div class="flex gap-2 mb-3">
                                            <input type="file" id="upload-qsops" class="hidden" accept=".pdf,.doc,.docx" onchange="handleDocumentUpload(event, 'Quality System SOPs')">
                                            <button onclick="document.getElementById('upload-qsops').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                                Upload
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2" id="thumbnails-qsops">
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/2D3748/FFFFFF?text=SOP" alt="SOP-QA-012" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">SOP-QA-012</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/4A5568/FFFFFF?text=SOP" alt="SOP-DOC-001" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">SOP-DOC-001</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Aseptic Process SOPs -->
                                <div class="border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('group-asops')">
                                        <div class="flex items-center flex-1">
                                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-group-asops" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        <span class="font-semibold">Aseptic Process SOPs</span>
                                    </div>
                                        <span class="text-xs text-slate-500 font-semibold">2 docs</span>
                                    </div>
                                    <div id="group-asops" class="p-3 bg-white border-t border-slate-200 hidden">
                                        <div class="flex gap-2 mb-3">
                                            <input type="file" id="upload-asops" class="hidden" accept=".pdf,.doc,.docx" onchange="handleDocumentUpload(event, 'Aseptic Process SOPs')">
                                            <button onclick="document.getElementById('upload-asops').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                                Upload
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2" id="thumbnails-asops">
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/805AD5/FFFFFF?text=SOP" alt="SOP-GOWN-001" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">SOP-GOWN-001</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/9F7AEA/FFFFFF?text=SOP" alt="SOP-ASEP-001" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">SOP-ASEP-001</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Executed Batch Records -->
                                <div class="border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('group-ebr')">
                                        <div class="flex items-center flex-1">
                                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-group-ebr" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        <span class="font-semibold">Executed Batch Records</span>
                                    </div>
                                        <span class="text-xs text-slate-500 font-semibold">3 docs</span>
                                    </div>
                                    <div id="group-ebr" class="p-3 bg-white border-t border-slate-200 hidden">
                                        <div class="flex gap-2 mb-3">
                                            <input type="file" id="upload-ebr" class="hidden" accept=".pdf,.doc,.docx" onchange="handleDocumentUpload(event, 'Executed Batch Records')">
                                            <button onclick="document.getElementById('upload-ebr').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                                Upload
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2" id="thumbnails-ebr">
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/059669/FFFFFF?text=Batch" alt="Batch 78910" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">Batch 78910</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/0891B2/FFFFFF?text=Batch" alt="Batch 78911" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">Batch 78911</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/0284C7/FFFFFF?text=Batch" alt="Batch 78912" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">Batch 78912</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Previous Audit Reports -->
                                <div class="border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('group-par')">
                                        <div class="flex items-center flex-1">
                                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-group-par" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        <span class="font-semibold">Previous Audit Reports</span>
                                    </div>
                                        <span class="text-xs text-slate-500 font-semibold">2 docs</span>
                                    </div>
                                    <div id="group-par" class="p-3 bg-white border-t border-slate-200 hidden">
                                        <div class="flex gap-2 mb-3">
                                            <input type="file" id="upload-par" class="hidden" accept=".pdf,.doc,.docx" onchange="handleDocumentUpload(event, 'Previous Audit Reports')">
                                            <button onclick="document.getElementById('upload-par').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                                Upload
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2" id="thumbnails-par">
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/DC2626/FFFFFF?text=Audit" alt="Audit 2023" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">Audit 2023</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/EA580C/FFFFFF?text=Audit" alt="Audit 2024" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">Audit 2024</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Training Records -->
                                <div class="border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('group-tr')">
                                        <div class="flex items-center flex-1">
                                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-group-tr" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        <span class="font-semibold">Training Records Database</span>
                                    </div>
                                        <span class="text-xs text-slate-500 font-semibold">1 doc</span>
                                    </div>
                                    <div id="group-tr" class="p-3 bg-white border-t border-slate-200 hidden">
                                        <div class="flex gap-2 mb-3">
                                            <input type="file" id="upload-tr" class="hidden" accept=".pdf,.doc,.docx,.xlsx" onchange="handleDocumentUpload(event, 'Training Records Database')">
                                            <button onclick="document.getElementById('upload-tr').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                                Upload
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-4 gap-2" id="thumbnails-tr">
                                            <div class="relative group">
                                                <img src="https://placehold.co/100x120/16A34A/FFFFFF?text=Training" alt="Training DB" class="w-full h-20 object-cover rounded border border-slate-200">
                                                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">Training DB</div>
                                                <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Environmental Monitoring Data -->
                                <div class="border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('group-em')">
                                        <div class="flex items-center flex-1">
                                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-group-em" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        <span class="font-semibold">Environmental Monitoring Data</span>
                                    </div>
                                        <span class="text-xs text-slate-500 font-semibold">0 docs</span>
                                </div>
                                    <div id="group-em" class="p-3 bg-white border-t border-slate-200 hidden">
                                        <div class="flex gap-2 mb-3">
                                            <input type="file" id="upload-em" class="hidden" accept=".pdf,.doc,.docx,.xlsx" onchange="handleDocumentUpload(event, 'Environmental Monitoring Data')">
                                            <button onclick="document.getElementById('upload-em').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                                Upload
                                            </button>
                            </div>
                                        <div class="grid grid-cols-4 gap-2" id="thumbnails-em">
                                            <div class="text-center text-slate-400 text-sm py-8 col-span-4">No documents uploaded yet</div>
                                </div>
                                </div>
                            </div>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <!-- LIVE FIELDWORK TAB -->
                <div id="fieldwork-content" class="hidden h-full overflow-hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 h-full gap-4 p-4">
                        <!-- Left Panel: Requirements Reference List -->
                        <div class="flex flex-col h-full bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4">
                                <h2 class="font-bold text-xl mb-2">📋 Requirements Reference</h2>
                                <div class="flex gap-4 text-sm">
                                    <div><span id="reqCountFieldwork">0</span> Requirements</div>
                                    <div><span id="obsCountFieldwork">0</span> Observations</div>
                                    <div><span id="gapCountFieldwork">0</span> Gaps</div>
                                </div>
                            </div>
                            
                            <div class="p-3 border-b border-slate-200 bg-slate-50">
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <button onclick="filterFieldworkRequirements('all')" class="filter-fieldwork-btn px-3 py-1 rounded-full text-xs font-semibold bg-slate-700 text-white">All</button>
                                    <button onclick="filterFieldworkRequirements('Critical')" class="filter-fieldwork-btn px-3 py-1 rounded-full text-xs font-semibold bg-slate-200 text-slate-700">Critical</button>
                                    <button onclick="filterFieldworkRequirements('High')" class="filter-fieldwork-btn px-3 py-1 rounded-full text-xs font-semibold bg-slate-200 text-slate-700">High</button>
                                    <button onclick="filterFieldworkRequirements('Medium')" class="filter-fieldwork-btn px-3 py-1 rounded-full text-xs font-semibold bg-slate-200 text-slate-700">Medium</button>
                                </div>
                                <input type="text" id="reqSearchFieldwork" placeholder="Search requirements..." class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm" oninput="searchFieldworkRequirements()">
                            </div>
                            
                            <div id="fieldworkReqList" class="flex-1 overflow-y-auto p-3 space-y-2">
                                <!-- Requirements list populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Right Panel: Observation Capture & Saved Observations -->
                        <div class="flex flex-col h-full bg-white rounded-lg shadow-lg overflow-hidden">
                            <!-- Observation Form - Collapsible -->
                            <div id="observationFormContainer" class="border-b border-slate-200">
                                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 cursor-pointer hover:from-purple-700 hover:to-blue-700" onclick="toggleObservationForm()">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h2 class="font-bold text-xl">📝 Observation Capture</h2>
                                            <p class="text-xs text-purple-100 mt-1">Capture evidence → AI analyzes → Match to requirement</p>
                                        </div>
                                        <svg id="formToggleIcon" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                <div id="observationFormContent" class="overflow-y-auto p-4 space-y-4 max-h-[calc(100vh-400px)]">
                                    <!-- Step 1: Multi-Modal Input -->
                                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-purple-200 rounded-lg p-4">
                                        <h4 class="text-sm font-bold text-purple-800 mb-3">STEP 1: Capture Evidence</h4>
                                        
                                        <div class="mb-3">
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">✍️ What did you observe? *</label>
                                            <textarea id="obsText" rows="5" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm" placeholder="Describe your observation in detail..."></textarea>
                                        </div>
                                        
                                        <!-- 2x2 Grid for Evidence Capture -->
                                        <div class="grid grid-cols-2 gap-3 mb-3">
                                            <!-- Photos (Top Left) -->
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">📸 Photos (Up to 5)</label>
                                                <input type="file" id="obsImageInput" accept="image/*" capture="environment" multiple class="hidden" onchange="handleMultipleImageCapture(event)">
                                                <button onclick="document.getElementById('obsImageInput').click()" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600" id="addPhotoBtn">
                                                    📸 Add Photos (<span id="photoCount">0</span>/5)
                                                </button>
                                                <!-- Image Gallery Preview -->
                                                <div id="imageGallery" class="mt-2 hidden">
                                                    <div id="imageGalleryGrid" class="grid grid-cols-2 gap-2">
                                                        <!-- Images will be added here dynamically -->
                                                    </div>
                                                    <input type="text" id="imageDescription" placeholder="Optional: Describe all photos..." class="mt-2 w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                                </div>
                                            </div>
                                            
                                            <!-- Audio Recording (Top Right) -->
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">🎤 Voice Recording</label>
                                                <button id="recordBtn" onclick="toggleRecording()" class="w-full px-3 py-2 bg-red-500 text-white rounded-lg text-xs font-semibold hover:bg-red-600">
                                                    🎤 <span id="recordBtnText">Record</span>
                                                </button>
                                                <div id="audioPreview" class="hidden mt-2 p-2 bg-slate-50 rounded border border-slate-200">
                                                    <span class="text-xs text-slate-700">🎤 <span id="recordDuration">0:00</span></span>
                                                </div>
                                                <textarea id="audioTranscription" placeholder="Transcription..." class="hidden mt-1 w-full px-2 py-1 border border-slate-300 rounded text-xs" rows="2"></textarea>
                                            </div>
                                            
                                            <!-- Documents (Bottom Left) -->
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">📄 Documents (PDFs)</label>
                                                <input type="file" id="obsDocumentInput" accept=".pdf,application/pdf" multiple class="hidden" onchange="handleDocumentUpload(event)">
                                                <button onclick="document.getElementById('obsDocumentInput').click()" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg text-xs font-semibold hover:bg-green-600" id="addDocBtn">
                                                    📄 Add Documents (<span id="docCount">0</span>)
                                                </button>
                                                <!-- Document List Preview -->
                                                <div id="documentList" class="mt-2 hidden">
                                                    <div id="documentListItems" class="space-y-1">
                                                        <!-- Documents will be listed here -->
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Handwritten Notes (Bottom Right) -->
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">✍️ Handwritten Notes</label>
                                                <input type="file" id="obsNotesInput" accept="image/*" class="hidden" onchange="handleHandwrittenNotesUpload(event)">
                                                <button onclick="document.getElementById('obsNotesInput').click()" class="w-full px-3 py-2 bg-orange-500 text-white rounded-lg text-xs font-semibold hover:bg-orange-600" id="addNotesBtn">
                                                    ✍️ Upload Notes
                                                </button>
                                                <!-- Notes Preview & Transcription -->
                                                <div id="notesPreview" class="mt-2 hidden">
                                                    <div class="relative">
                                                        <img id="notesImage" class="w-full rounded border-2 border-orange-300" alt="Handwritten notes">
                                                        <button onclick="clearHandwrittenNotes()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold hover:bg-red-600">×</button>
                                                    </div>
                                                    <button onclick="transcribeHandwrittenNotes()" id="transcribeNotesBtn" class="w-full mt-2 px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-semibold hover:bg-purple-700">
                                                        🤖 Transcribe with AI
                                                    </button>
                                                    <div id="notesTranscriptionArea" class="hidden mt-2">
                                                        <label class="block text-xs font-semibold text-slate-600 mb-1">Transcription:</label>
                                                        <textarea id="notesTranscription" rows="3" class="w-full px-2 py-1 border border-slate-300 rounded text-xs" placeholder="AI transcription will appear here..."></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Location & Interviewed Fields -->
                                        <div class="grid grid-cols-2 gap-3 mb-3">
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">📍 Location</label>
                                                <input type="text" id="obsLocation" class="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-xs" placeholder="e.g., Filling Room 2">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">👥 Interviewed</label>
                                                <input type="text" id="obsInterviewed" class="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-xs" placeholder="e.g., J. Smith, QA Manager">
                                            </div>
                                        </div>
                                        
                                        <button onclick="analyzeWithAI()" id="analyzeBtn" class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold hover:from-purple-700 hover:to-blue-700">
                                            ⚡ Analyze with AI
                                        </button>
                                    </div>
                                    
                                    <!-- Step 2: AI Recommendation (appears after analysis) -->
                                    <div id="requirementMatchSection" class="hidden">
                                        <div class="bg-gradient-to-br from-green-50 to-blue-50 border-2 border-green-300 rounded-lg p-4">
                                            <h4 class="text-sm font-bold text-green-800 mb-3">STEP 2: Link to Requirements (Multi-Select)</h4>
                                            
                                            <!-- AI Suggested Matches (Multiple) -->
                                            <div class="mb-3">
                                                <div class="text-xs font-bold text-green-700 mb-2">🤖 AI Recommendations:</div>
                                                <div id="aiMatchedReqs" class="space-y-2">
                                                    <!-- Populated by JavaScript with multiple matches -->
                                                </div>
                                            </div>
                                            
                                            <!-- Manual Selection with Checkboxes -->
                                            <div>
                                                <div class="flex items-center justify-between mb-2">
                                                    <label class="block text-xs font-semibold text-slate-700">
                                                        Select requirement(s) - multiple allowed:
                                                    </label>
                                                    <button onclick="selectAllAIRecommendations()" class="text-xs text-blue-600 hover:text-blue-800 font-semibold">
                                                        ✓ Select All AI
                                                    </button>
                                                </div>
                                                <div id="requirementCheckboxes" class="max-h-48 overflow-y-auto space-y-2 p-2 bg-white rounded border border-slate-300">
                                                    <!-- Populated by JavaScript with checkboxes -->
                                                </div>
                                                <div class="mt-2 text-xs text-slate-600">
                                                    <span id="selectedCount" class="font-semibold">0</span> requirement(s) selected
                                                </div>
                                            </div>
                                            
                                            <!-- AI Insights -->
                                            <div id="aiInsights" class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                <div class="text-xs font-semibold text-blue-800 mb-1">💡 AI Insights:</div>
                                                <div id="aiKeyFindings" class="text-xs text-blue-700"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 2b: AI-Suggested Observation Text -->
                                    <div id="aiObservationTextSection" class="hidden">
                                        <div class="bg-gradient-to-br from-amber-50 to-yellow-50 border-2 border-amber-300 rounded-lg p-4">
                                            <h4 class="text-sm font-bold text-amber-800 mb-2">✨ AI-Generated Observation</h4>
                                            <p class="text-xs text-amber-700 mb-3">Based on your evidence, here's a suggested observation text:</p>
                                            
                                            <div class="bg-white rounded-lg p-3 border-2 border-amber-200 mb-3">
                                                <div id="aiSuggestedObsText" class="text-sm text-slate-700 whitespace-pre-wrap"></div>
                                            </div>
                                            
                                            <div class="flex gap-2">
                                                <button onclick="acceptAISuggestedText()" class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700">
                                                    ✓ Use This Text
                                                </button>
                                                <button onclick="document.getElementById('aiObservationTextSection').classList.add('hidden')" class="flex-1 px-3 py-2 bg-slate-400 text-white rounded-lg text-xs font-semibold hover:bg-slate-500">
                                                    ✗ Keep My Text
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 3: Additional Details -->
                                    <div id="additionalDetailsSection" class="hidden">
                                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                            <h4 class="text-sm font-bold text-slate-700 mb-3">STEP 3: Complete Details</h4>
                                            
                                            <!-- Compliance Status -->
                                            <div class="mb-3">
                                                <label class="block text-xs font-semibold text-slate-700 mb-2">
                                                    🎯 Compliance Status <span id="aiSuggestedStatus" class="text-green-600"></span>
                                                </label>
                                                <div class="grid grid-cols-3 gap-2">
                                                    <label class="flex flex-col items-center p-2 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50">
                                                        <input type="radio" name="obsStatus" value="compliant" class="mb-1">
                                                        <span class="text-xs font-medium text-green-700">✓ Compliant</span>
                                                    </label>
                                                    <label class="flex flex-col items-center p-2 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 has-[:checked]:border-amber-500 has-[:checked]:bg-amber-50">
                                                        <input type="radio" name="obsStatus" value="gap" checked class="mb-1">
                                                        <span class="text-xs font-medium text-amber-700">⚠️ Gap</span>
                                                    </label>
                                                    <label class="flex flex-col items-center p-2 border-2 border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 has-[:checked]:border-red-500 has-[:checked]:bg-red-50">
                                                        <input type="radio" name="obsStatus" value="non-compliant" class="mb-1">
                                                        <span class="text-xs font-medium text-red-700">✗ Non-Compliant</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Severity -->
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-700 mb-2">
                                                    Severity <span id="aiSuggestedSeverity" class="text-green-600"></span>
                                                </label>
                                                <select id="obsSeverity" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                                    <option value="minor">Minor</option>
                                                    <option value="major" selected>Major</option>
                                                    <option value="critical">Critical</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Form Actions - Always Visible -->
                                <div class="p-4 border-t border-slate-200 bg-slate-50 flex gap-3">
                                    <button onclick="resetObservationForm()" class="flex-1 px-4 py-3 bg-slate-300 text-slate-700 rounded-lg font-semibold hover:bg-slate-400">🔄 Clear</button>
                                    <button onclick="saveObservation()" id="saveObsBtn" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>💾 Save Observation</button>
                                </div>
                            </div>
                            
                            <!-- Saved Observations List -->
                            <div class="flex-1 flex flex-col overflow-hidden">
                                <div class="bg-slate-100 border-b border-slate-300 p-3">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-bold text-lg text-slate-800">
                                            📋 Saved Observations (<span id="savedObsCount">0</span>)
                                        </h3>
                                        <button onclick="refreshSavedObservations()" class="px-3 py-1 bg-slate-600 text-white rounded text-xs hover:bg-slate-700">
                                            🔄 Refresh
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="savedObservationsList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                                    <!-- Saved observations populated by JavaScript -->
                                    <div class="text-center text-slate-500 py-8">
                                        <p class="text-sm">No observations saved yet.</p>
                                        <p class="text-xs mt-2">Complete the form above to create your first observation.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FINALIZATION TAB -->
                <div id="finalization-content" class="hidden p-6">
                    <h2 class="font-bold text-2xl text-[#0D47A1] mb-6">📊 Report Finalization & Generation</h2>
                    
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                            <div class="text-sm text-blue-600 font-semibold">Total Observations</div>
                            <div class="text-3xl font-bold text-blue-800" id="finalTotalObs">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-lg border border-amber-200">
                            <div class="text-sm text-amber-600 font-semibold">Draft</div>
                            <div class="text-3xl font-bold text-amber-800" id="finalDraftCount">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-green-600 font-semibold">Finalized</div>
                            <div class="text-3xl font-bold text-green-800" id="finalFinalCount">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                            <div class="text-sm text-red-600 font-semibold">Gaps Found</div>
                            <div class="text-3xl font-bold text-red-800" id="finalGapsCount">0</div>
                        </div>
                    </div>
                    
                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left: Observations Management -->
                        <div class="bg-white rounded-lg shadow-lg border border-slate-200">
                            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 rounded-t-lg">
                                <h3 class="font-bold text-lg">📝 Observations</h3>
                                <p class="text-xs text-purple-100 mt-1">Review and finalize observations for the report</p>
                            </div>
                            
                            <!-- Filter Tabs -->
                            <div class="p-4 border-b border-slate-200 bg-slate-50">
                                <div class="flex gap-2 justify-between items-center">
                                    <div class="flex gap-2">
                                        <button onclick="filterFinalizationObs('all')" class="finalization-filter-btn px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white">
                                            All (<span id="filterAllCount">0</span>)
                                        </button>
                                        <button onclick="filterFinalizationObs('draft')" class="finalization-filter-btn px-4 py-2 rounded-lg text-sm font-semibold bg-slate-200 text-slate-700">
                                            Draft (<span id="filterDraftCount">0</span>)
                                        </button>
                                        <button onclick="filterFinalizationObs('final')" class="finalization-filter-btn px-4 py-2 rounded-lg text-sm font-semibold bg-slate-200 text-slate-700">
                                            Final (<span id="filterFinalCount">0</span>)
                                        </button>
                                    </div>
                                    <button onclick="renderFinalizationTab()" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold hover:bg-purple-700" title="Refresh observations from Fieldwork">
                                        🔄 Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Observations List -->
                            <div id="finalizationObsList" class="p-4 space-y-3 max-h-[600px] overflow-y-auto">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Right: Report Builder -->
                        <div class="bg-white rounded-lg shadow-lg border border-slate-200">
                            <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 rounded-t-lg">
                                <h3 class="font-bold text-lg">📄 Final Report</h3>
                                <p class="text-xs text-green-100 mt-1">Generate comprehensive audit report</p>
                            </div>
                            
                            <div class="p-6 space-y-6">
                                <!-- Overall Assessment -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Overall Assessment</label>
                                    <div class="grid grid-cols-3 gap-3">
                                        <button onclick="selectGrade('acceptable')" id="grade-acceptable" class="grade-btn flex flex-col items-center p-3 bg-slate-100 rounded-lg border-2 border-slate-300 hover:bg-green-50 hover:border-green-500">
                                            <span class="text-2xl">✓</span>
                                            <span class="text-xs font-semibold mt-1">Acceptable</span>
                                        </button>
                                        <button onclick="selectGrade('conditional')" id="grade-conditional" class="grade-btn flex flex-col items-center p-3 bg-slate-100 rounded-lg border-2 border-slate-300 hover:bg-amber-50 hover:border-amber-500">
                                            <span class="text-2xl">⚠</span>
                                            <span class="text-xs font-semibold mt-1 text-center">Conditional</span>
                                        </button>
                                        <button onclick="selectGrade('unacceptable')" id="grade-unacceptable" class="grade-btn flex flex-col items-center p-3 bg-slate-100 rounded-lg border-2 border-slate-300 hover:bg-red-50 hover:border-red-500">
                                            <span class="text-2xl">✗</span>
                                            <span class="text-xs font-semibold mt-1">Unacceptable</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Executive Summary -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Executive Summary</label>
                                    <textarea id="executiveSummary" rows="6" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Provide a high-level summary of the audit findings, overall compliance status, and key recommendations..."></textarea>
                                </div>
                                
                                <!-- Key Findings -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Key Findings</label>
                                    <textarea id="keyFindings" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Summarize the most significant observations and trends..."></textarea>
                                </div>
                                
                                <!-- Recommendations -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Recommendations</label>
                                    <textarea id="recommendations" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Provide overall recommendations for improvement..."></textarea>
                                </div>
                                
                                <!-- Actions -->
                                <div class="flex gap-3 pt-4 border-t border-slate-200">
                                    <button onclick="generateDraftReport()" class="flex-1 px-4 py-3 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600">
                                        📝 Generate Draft
                                    </button>
                                    <button onclick="generateFinalReport()" id="generateFinalBtn" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        ✓ Generate Final Report
                                    </button>
                                </div>
                                <p id="reportHelper" class="text-xs text-slate-600 text-center">All observations must be finalized to generate the final report</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="modalContainer"></div>
    
    <!-- Observation Detail Modal -->
    <div id="observationDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 flex justify-between items-center">
                <h2 class="font-bold text-xl">📋 Observation Details</h2>
                <button onclick="closeObservationModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
            </div>
            
            <!-- Modal Content -->
            <div id="observationModalContent" class="overflow-y-auto max-h-[calc(90vh-80px)] p-6">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // DATA MODEL & STATE
        let currentTab = 'prep'; let currentAgendaId = '1.0'; let observationToFinalizeId = null; let nextObservationId = 8; let findingsChartInstance = null;
        
        // Document data for Pre-Audit Prep - Synced with Document Requests and Focus Areas
        const uploadedDocuments = [
            // Master Batch Records
            {
                id: 'doc-001',
                title: 'MBR-FILL-002 Rev 3',
                type: 'PDF',
                size: '3.1 MB',
                uploadDate: '2025-09-25',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/0D47A1/FFFFFF?text=MBR-FILL-002',
                fullDocument: 'https://placehold.co/800x1000/0D47A1/FFFFFF?text=MBR-FILL-002+Rev+3',
                category: 'Master Batch Records'
            },
            
            // Quality System SOPs
            {
                id: 'doc-002',
                title: 'SOP-QA-012: Batch Record Issuance',
                type: 'PDF',
                size: '1.2 MB',
                uploadDate: '2025-09-25',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/2D3748/FFFFFF?text=SOP-QA-012',
                fullDocument: 'https://placehold.co/800x1000/2D3748/FFFFFF?text=SOP-QA-012',
                category: 'Quality System SOPs'
            },
            {
                id: 'doc-003',
                title: 'SOP-DOC-001: Document Control',
                type: 'PDF',
                size: '1.8 MB',
                uploadDate: '2025-09-25',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/4A5568/FFFFFF?text=SOP-DOC-001',
                fullDocument: 'https://placehold.co/800x1000/4A5568/FFFFFF?text=SOP-DOC-001',
                category: 'Quality System SOPs'
            },
            
            // Aseptic Process SOPs
            {
                id: 'doc-004',
                title: 'SOP-GOWN-001: Aseptic Gowning',
                type: 'PDF',
                size: '2.7 MB',
                uploadDate: '2025-09-26',
                status: 'Analyzing',
                thumbnail: 'https://placehold.co/300x400/805AD5/FFFFFF?text=SOP-GOWN-001',
                fullDocument: 'https://placehold.co/800x1000/805AD5/FFFFFF?text=SOP-GOWN-001',
                category: 'Aseptic Process SOPs'
            },
            {
                id: 'doc-005',
                title: 'SOP-ASEP-001 Rev 4: Aseptic Technique',
                type: 'PDF',
                size: '2.9 MB',
                uploadDate: '2025-09-26',
                status: 'Analyzing',
                thumbnail: 'https://placehold.co/300x400/9F7AEA/FFFFFF?text=SOP-ASEP-001',
                fullDocument: 'https://placehold.co/800x1000/9F7AEA/FFFFFF?text=SOP-ASEP-001',
                category: 'Aseptic Process SOPs'
            },
            
            // Executed Batch Records
            {
                id: 'doc-006',
                title: 'Batch Record 78910',
                type: 'PDF',
                size: '4.2 MB',
                uploadDate: '2025-09-26',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/059669/FFFFFF?text=Batch+78910',
                fullDocument: 'https://placehold.co/800x1000/059669/FFFFFF?text=Batch+78910',
                category: 'Executed Batch Records'
            },
            {
                id: 'doc-007',
                title: 'Batch Record 78911',
                type: 'PDF',
                size: '4.1 MB',
                uploadDate: '2025-09-26',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/0891B2/FFFFFF?text=Batch+78911',
                fullDocument: 'https://placehold.co/800x1000/0891B2/FFFFFF?text=Batch+78911',
                category: 'Executed Batch Records'
            },
            {
                id: 'doc-008',
                title: 'Batch Record 78912',
                type: 'PDF',
                size: '4.3 MB',
                uploadDate: '2025-09-26',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/0284C7/FFFFFF?text=Batch+78912',
                fullDocument: 'https://placehold.co/800x1000/0284C7/FFFFFF?text=Batch+78912',
                category: 'Executed Batch Records'
            },
            
            // Previous Audit Reports
            {
                id: 'doc-009',
                title: 'Audit Report 2023',
                type: 'PDF',
                size: '5.8 MB',
                uploadDate: '2025-09-27',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/DC2626/FFFFFF?text=Audit+2023',
                fullDocument: 'https://placehold.co/800x1000/DC2626/FFFFFF?text=Audit+2023',
                category: 'Previous Audit Reports'
            },
            {
                id: 'doc-010',
                title: 'Audit Report 2024',
                type: 'PDF',
                size: '6.2 MB',
                uploadDate: '2025-09-27',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/EA580C/FFFFFF?text=Audit+2024',
                fullDocument: 'https://placehold.co/800x1000/EA580C/FFFFFF?text=Audit+2024',
                category: 'Previous Audit Reports'
            },
            
            // Training Records
            {
                id: 'doc-011',
                title: 'Training Database 2025',
                type: 'XLSX',
                size: '2.1 MB',
                uploadDate: '2025-09-27',
                status: 'Analyzed',
                thumbnail: 'https://placehold.co/300x400/16A34A/FFFFFF?text=Training+DB',
                fullDocument: 'https://placehold.co/800x1000/16A34A/FFFFFF?text=Training+Database',
                category: 'Training Records'
            }
        ];
        
        // Focus Areas data organized by risk level
        const focusAreas = [
            {
                id: 1,
                risk: 'critical',
                title: 'Data Integrity: Potential Batch Record Alteration',
                description: 'Analysis of Batch Records 78910, 78911, and 78912 shows identical signatures across multiple time points with pixel-perfect matches, suggesting potential copy-paste activity rather than authentic signatures.',
                sources: ['Batch Record 78910', 'Batch Record 78911', 'Batch Record 78912'],
                regulations: ['21 CFR 211.188', '21 CFR 211.192', 'ALCOA+ Principles'],
                impact: 'Patient Safety & Product Quality',
                recommendation: 'Immediate investigation required. Review all batch records from same operator/period. Verify with operator interviews.'
            },
            {
                id: 2,
                risk: 'critical',
                title: 'Aseptic Processing: Critical Step Not in SOP',
                description: 'Batch records show a critical sterility check performed before filling, but this step is not documented in SOP-FILL-002. This represents an undocumented critical control point.',
                sources: ['SOP-FILL-002 (Pending)', 'Batch Record 78910', 'Batch Record 78911'],
                regulations: ['21 CFR 211.100', '21 CFR 211.113', 'EU GMP Annex 1 (8.123)'],
                impact: 'Sterility Assurance',
                recommendation: 'Verify practice during facility tour. Determine if SOP requires update or if practice should be discontinued.'
            },
            {
                id: 3,
                risk: 'high',
                title: 'Batch Record vs Master Batch Record Discrepancy',
                description: 'Master Batch Record (MBR-FILL-002 rev. 3) specifies mixing time of 30 ± 5 minutes. However, executed batch record templates show pre-printed "Mixing Time (20 mins)" - indicating document control failure.',
                sources: ['MBR-FILL-002 Rev 3', 'Batch Record 78910', 'SOP-QA-012: Batch Record Issuance'],
                regulations: ['21 CFR 211.188', 'SOP-DOC-001 (Document Control)'],
                impact: 'Process Control & Documentation',
                recommendation: 'Review document change control process. Assess if mixing was performed correctly despite incorrect pre-print.'
            },
            {
                id: 4,
                risk: 'high',
                title: 'Aseptic Gowning SOP - Ambiguous Procedure',
                description: 'SOP-GOWN-001 does not specify the sequence for donning sterile face masks vs. sterile gloves. Ambiguity creates risk of inconsistent practices and potential contamination.',
                sources: ['SOP-GOWN-001: Aseptic Gowning'],
                regulations: ['EU GMP Annex 1 (7.14)', '21 CFR 211.113'],
                impact: 'Contamination Control',
                recommendation: 'Observe gowning practices during facility tour. Determine if training compensates for SOP gap.'
            },
            {
                id: 5,
                risk: 'high',
                title: 'Recurring CAPA Ineffectiveness',
                description: 'Previous audit reports from 2023 and 2024 both cited "incomplete batch record review" issues. Current batch records still show incomplete QA review signatures, suggesting CAPA was ineffective.',
                sources: ['Audit Report 2023', 'Audit Report 2024', 'Batch Record 78910', 'Batch Record 78911'],
                regulations: ['21 CFR 211.192', '21 CFR 211.22'],
                impact: 'Quality System Effectiveness',
                recommendation: 'Deep-dive into CAPA system. Assess root cause analysis quality and effectiveness verification.'
            },
            {
                id: 6,
                risk: 'high',
                title: 'Training Records: Overdue Qualifications',
                description: 'Training database shows 3 operators with overdue aseptic technique requalification (>30 days past due), yet they continue to perform aseptic operations on Line 2.',
                sources: ['Training Database 2025', 'Batch Record 78910', 'Batch Record 78912'],
                regulations: ['21 CFR 211.25(a)', 'SOP-HR-005'],
                impact: 'Personnel Qualification',
                recommendation: 'Review training management system. Verify operator competency despite overdue paperwork.'
            },
            {
                id: 7,
                risk: 'medium',
                title: 'SOP Revision History Gap',
                description: 'SOP-ASEP-001 shows jump from Rev. 2 (2023) to Rev. 4 (2025) with no documented Rev. 3. May indicate document control error or missing revision.',
                sources: ['SOP-ASEP-001 Rev 4: Aseptic Technique', 'SOP-DOC-001: Document Control'],
                regulations: ['21 CFR 211.100', 'SOP-DOC-001'],
                impact: 'Document Control',
                recommendation: 'Verify with document control department. Low risk but indicates potential procedural gap.'
            },
            {
                id: 8,
                risk: 'medium',
                title: 'Environmental Monitoring - Pending Analysis',
                description: 'Awaiting EM data for statistical trend analysis. Will analyze for process drift, seasonal variations, and alert/action level excursions.',
                sources: ['Environmental Monitoring Data (Pending Upload)'],
                regulations: ['21 CFR 211.42', '21 CFR 211.113'],
                impact: 'Environmental Control',
                recommendation: 'Request EM data. Perform trend analysis before audit.'
            }
        ];
        
        let currentFocusFilter = 'all';
        
        // Audit Plan Items - tracks which focus areas have been added to the audit plan
        let auditPlanItems = [];
        
        const agendaMap = {'1.0':'Opening Meeting','2.0':'QMS & Doc Review','3.0':'Facility Tour','3.1':'Gowning & Material Airlock','3.2':'Aseptic Filling Suite (Line 2)','3.3':'QC Microbiology Lab','4.0':'End of Day Debrief'};
        let auditData = [
            {id:0,agendaId:'1.0',type:'Note',title:'Audit Scope Confirmed',text:'Opening meeting held with site leadership. Audit scope, agenda, and logistics were confirmed. No issues noted.',status:'Finalized',severity:null,evidence:[],capaRecommendation:null, regulations: []},
            {id:1,agendaId:'2.0',type:'Observation',title:'Discrepancy in Batch Record Template',text:'The approved Master Batch Record (MBR-FILL-002 rev. 3) specifies a mixing time of 30 +/- 5 minutes. However, the executed batch record for Lot 78910 shows a pre-printed field for "Mixing Time (20 mins)", which does not match the MBR.',status:'Finalized',severity:'Minor',evidence:[{type:'doc',src:'https://placehold.co/600x400/2D3748/FFFFFF?text=MBR-FILL-002', alt: 'Master Batch Record' },{type:'doc',src:'https://placehold.co/600x400/718096/FFFFFF?text=BPR+Lot+78910', alt: 'Executed Batch Record'}],capaRecommendation:"Implement a mandatory reconciliation step in the document change control process to verify that all related templates (e.g., BPRs) are updated concurrently with the parent document (e.g., MBR). Perform a gap assessment to identify other similar discrepancies.", regulations: [{id: "21 CFR 211.188", justification: "Requires that batch production records are an accurate reproduction of the master production record."}, {id: "SOP-DOC-001", justification: "The internal procedure for document control, which failed to ensure templates were correctly updated."}]},
            {id:6,agendaId:'2.0',type:'Observation',title:'Overdue Training Records',text:'The training record for operator J. Doe on aseptic gowning qualification (SOP-GOWN-001) was found to be overdue by 3 months. J. Doe is a primary operator for Filling Line 2.',status:'Finalized',severity:'Minor',evidence:[{type:'doc',src:'https://placehold.co/600x400/4A5568/FFFFFF?text=J.+Doe+Training+File', alt: 'Training File'}],capaRecommendation:"Evaluate the Learning Management System (LMS) for automated notifications to supervisors for upcoming and overdue training. Implement a process where operators with overdue critical qualifications are automatically restricted from performing those GMP tasks.", regulations: [{id: "21 CFR 211.25(a)", justification: "Requires that personnel have the education, training, and experience to perform their assigned functions, including periodic training."},{id: "SOP-HR-005", justification: "Defines the internal requalification frequency for GMP tasks."}]},
            {id:4,agendaId:'3.1',type:'Observation',title:'Improper Gowning Sequence',text:'An operator entering the Grade C gowning room was observed putting on their sterile face mask after donning sterile gloves, creating a risk of glove contamination. This violates the procedure in SOP-GOWN-001.',status:'Draft',severity:null,evidence:[{type:'photo',src:'https://images.unsplash.com/photo-1581092921446-54a103c17b16?q=80&w=800&auto=format&fit=crop',alt:'Scientist in cleanroom adjusting mask'}],capaRecommendation:"Review and enhance the gowning training module with clearer visual aids for the correct sequence. Observe multiple operators during gowning to verify training effectiveness and identify other common errors.", regulations: [{id: "EU GMP Annex 1", justification: "Details specific requirements for personnel gowning in a manner that prevents contamination."}, {id: "SOP-GOWN-001", justification: "The site's own procedure for gowning was not followed."}]},
            {id:5,agendaId:'3.1',type:'Observation',title:'Damaged Transfer Hatch Gasket',text:'The silicone gasket on the material transfer hatch between the Grade D and Grade C areas was observed to be torn. This compromises the integrity of the pressure cascade and risks ingress of lower-quality air into the cleaner space.',status:'Finalized',severity:'Major',evidence:[{type:'photo',src:'https://images.unsplash.com/photo-1580894324695-63a2dfe8393b?q=80&w=800&auto=format&fit=crop',alt:'Close-up of a torn rubber gasket'}],capaRecommendation:"Incorporate a daily visual inspection of all cleanroom gaskets into the pre-operational checklist. Establish a formal preventive maintenance schedule for the replacement of all critical gaskets based on manufacturer recommendations or a performance qualification study.", regulations: [{id: "21 CFR 211.67(b)", justification: "Requires that equipment be maintained in a good state of repair."}, {id: "SOP-MAINT-010", justification: "The internal procedure for preventive maintenance."}]},
            {id:2,agendaId:'3.2',type:'Observation',title:'Improper Aseptic Technique',text:'During filling on Line 2, an operator was observed reaching over an open container of sterile stoppers to make an adjustment. This action compromises the sterility of the stoppers and is a deviation from aseptic principles and SOP-ASEP-001.',status:'Finalized',severity:'Major',evidence:[{type:'photo',src:'https://images.unsplash.com/photo-1581093582522-23136087b3a6?q=80&w=800&auto=format&fit=crop',alt:'Operator reaching over sterile components in a filling line'}],capaRecommendation:"Conduct an immediate Aseptic Technique requalification for all Line 2 operators. Review the ergonomic design of the filling line to determine if equipment layout encourages or necessitates improper technique. Increase supervisory oversight of aseptic operations.", regulations: [{id: "21 CFR 211.113(b)", justification: "Requires that aseptic processes include procedures to prevent microbial contamination."}, {id: "SOP-ASEP-001", justification: "The internal procedure defining correct aseptic technique."}]},
            {id:3,agendaId:'3.3',type:'Observation',title:'Adverse Trend in Particle Counts',text:'Aura AI analysis of EM data for the past 6 months identified a statistically significant upward trend of non-viable particle counts (0.5µm) in the Grade B area supporting Line 2. The trend indicates a potential degradation in the state of control.',status:'Finalized',severity:'Major',evidence:[{type:'doc',src:'https://placehold.co/600x400/0D47A1/FFFFFF?text=EM+Data+Trend+Chart', alt: 'EM Data Trend Chart'}],capaRecommendation:"Initiate a formal investigation into the adverse EM trend to identify the root cause (e.g., HVAC performance, gowning issues, equipment shedding). The investigation should include a risk assessment for product potentially impacted during the trend period.", regulations: [{id: "21 CFR 211.42(c)(10)(iv)", justification: "Requires establishing an adequate system for monitoring environmental conditions."}, {id: "SOP-EM-001", justification: "The internal procedure for environmental monitoring and trend analysis."}]},
            {id:7,agendaId:'4.0',type:'Note',title:'Key Findings Discussed',text:'End-of-day debrief held with Head of Quality and Head of Production. Major findings regarding aseptic technique, EM trends, and the transfer hatch were communicated. Site acknowledged the issues and committed to initiating investigations.',status:'Finalized',severity:null,evidence:[],capaRecommendation:null, regulations: []}
        ];
        
        // MAIN TAB LOGIC
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            ['prep', 'fieldwork', 'finalization'].forEach(t => document.getElementById(`${t}-content`).classList.add('hidden'));
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById('auditStatus').textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            if (tabName === 'prep') {
                renderDocumentGallery();
                // renderFocusAreas(); // Removed - section no longer exists
            }
            if (tabName === 'fieldwork') {
       initializeFieldwork();
   }
            if (tabName === 'finalization') renderFinalizationTab();
        }
        
        // DOCUMENT GALLERY FUNCTIONS
        function renderDocumentGallery() {
            const gallery = document.getElementById('documentGallery');
            if (!gallery) return;
            
            // Load documents from backend if not already loaded
            if (uploadedDocuments.length === 0) {
                loadDocumentsFromBackend();
                return;
            }
            
            gallery.innerHTML = uploadedDocuments.map(doc => {
                const statusClass = doc.status === 'Analyzed' ? 'bg-green-100 text-green-800' : 
                                  doc.status === 'Analyzing' ? 'bg-blue-100 text-blue-800' : 
                                  'bg-amber-100 text-amber-800';
                const statusIcon = doc.status === 'Analyzed' ? '✓' : 
                                 doc.status === 'Analyzing' ? '⟳' : '⏳';
                
                return `
                    <div class="bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="openDocumentViewer('${doc.id}')">
                        <div class="aspect-[3/4] bg-slate-100 rounded-t-lg overflow-hidden">
                            <img src="${doc.thumbnail}" alt="${doc.title}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-4">
                            <div class="flex items-start justify-between mb-2">
                                <h4 class="font-semibold text-sm text-slate-800 line-clamp-2">${doc.title}</h4>
                                <span class="text-xs font-semibold ${statusClass} px-2 py-1 rounded-full flex items-center">
                                    <span class="mr-1">${statusIcon}</span>
                                    ${doc.status}
                                </span>
                            </div>
                            <div class="text-xs text-slate-500 space-y-1">
                                <div class="flex justify-between">
                                    <span>Type:</span>
                                    <span class="font-medium">${doc.type}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Size:</span>
                                    <span class="font-medium">${doc.size}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Uploaded:</span>
                                    <span class="font-medium">${doc.uploadDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Category:</span>
                                    <span class="font-medium text-blue-600">${doc.category}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openDocumentViewer(docId) {
            const doc = uploadedDocuments.find(d => d.id === docId);
            if (!doc) return;
            
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `
                <div id="documentViewerModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex justify-center items-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-[95vw] max-h-[98vh] flex flex-col">
                        <header class="p-4 border-b flex justify-between items-center shrink-0">
                            <div>
                                <h2 class="text-xl font-bold text-[#0D47A1]">${doc.title}</h2>
                                <p class="text-sm text-slate-500">${doc.type} • ${doc.size} • Uploaded ${doc.uploadDate}</p>
                            </div>
                            <button onclick="closeAllModals()" class="text-slate-500 hover:text-red-500 text-3xl">&times;</button>
                        </header>
                        <div class="flex-grow overflow-hidden flex">
                            <div class="w-1/3 bg-slate-50 p-4 border-r border-slate-200 overflow-y-auto">
                                <h3 class="font-semibold text-lg mb-4">Document Details</h3>
                                <div class="space-y-4">
                                    <div>
                                        <h4 class="font-semibold text-sm text-slate-600 mb-1">Category</h4>
                                        <p class="text-sm text-slate-800">${doc.category}</p>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-sm text-slate-600 mb-1">Status</h4>
                                        <span class="inline-block text-xs font-semibold ${doc.status === 'Analyzed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} px-2 py-1 rounded-full">
                                            ${doc.status === 'Analyzed' ? '✓ Analyzed' : '⟳ Analyzing'}
                                        </span>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-sm text-slate-600 mb-1">File Information</h4>
                                        <div class="text-xs text-slate-700 space-y-1">
                                            <div>Type: ${doc.type}</div>
                                            <div>Size: ${doc.size}</div>
                                            <div>Uploaded: ${doc.uploadDate}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-sm text-slate-600 mb-1">AI Analysis</h4>
                                        <p class="text-xs text-slate-700">${doc.status === 'Analyzed' ? 'Document has been processed and analyzed by Aura AI. Key findings and discrepancies have been identified.' : 'Document is currently being analyzed by Aura AI. Analysis will be available shortly.'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-grow p-4 overflow-y-auto">
                                <div class="bg-slate-100 rounded-lg p-4 text-center">
                                    ${doc.type === 'PDF' ? 
                                        `<iframe src="${doc.fullDocument}" class="w-full h-full min-h-[1000px] rounded-lg shadow-lg border-0"></iframe>` :
                                        `<img src="${doc.fullDocument}" alt="${doc.title}" class="max-w-full h-auto mx-auto rounded-lg shadow-lg">`
                                    }
                                </div>
                            </div>
                        </div>
                        <footer class="p-4 bg-slate-50 border-t flex justify-end space-x-3 shrink-0">
                            <button onclick="downloadDocument('${doc.id}')" class="bg-slate-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-slate-600">
                                Download PDF
                            </button>
                            <button onclick="closeAllModals()" class="bg-[#0D47A1] text-white font-bold px-4 py-2 rounded-lg hover:bg-opacity-90">
                                Close
                            </button>
                        </footer>
                    </div>
                </div>
            `;
        }
        
        function downloadDocument(docId) {
            const doc = uploadedDocuments.find(d => d.id === docId);
            if (!doc) return;
            
            // Download from backend
            window.open(`/api/document/${doc.filename}/download`, '_blank');
        }
        
        function loadDocumentsFromBackend() {
            fetch('/api/documents')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear existing documents and add backend documents
                        uploadedDocuments.length = 0;
                        uploadedDocuments.push(...data.documents);
                        renderDocumentGallery();
                    } else {
                        console.error('Failed to load documents:', data.message);
                        // Fall back to sample data if backend fails
                        renderDocumentGallery();
                    }
                })
                .catch(error => {
                    console.error('Error loading documents:', error);
                    // Fall back to sample data if backend fails
                    renderDocumentGallery();
                });
        }
        
        // AUDIO RECORDING FUNCTIONS (for document upload)
        let docMediaRecorder;
        let docAudioChunks = [];
        let docRecordingStartTime;

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                docMediaRecorder = new MediaRecorder(stream);
                docAudioChunks = [];
                
                docMediaRecorder.ondataavailable = (event) => {
                    docAudioChunks.push(event.data);
                };
                
                docMediaRecorder.onstop = () => {
                    const audioBlob = new Blob(docAudioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPlayback = document.getElementById('audioPlayback');
                    audioPlayback.src = audioUrl;
                    audioPlayback.classList.remove('hidden');
                    
                    // Simulate transcription
                    simulateTranscription();
                };
                
                docMediaRecorder.start();
                docRecordingStartTime = Date.now();
                updateRecordingUI(true);
                updateRecordingTimer();
            } catch (error) {
                alert('Unable to access microphone. Please check permissions.');
                console.error('Recording error:', error);
            }
        }

        function stopRecording() {
            if (docMediaRecorder && docMediaRecorder.state !== 'inactive') {
                docMediaRecorder.stop();
                docMediaRecorder.stream.getTracks().forEach(track => track.stop());
                updateRecordingUI(false);
            }
        }

        function updateRecordingUI(isRecording) {
            const recordBtn = document.getElementById('recordBtn');
            const recordingStatus = document.getElementById('recordingStatus');
            
            if (isRecording) {
                recordBtn.innerHTML = `
                    <svg class="h-4 w-4 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                        <rect x="6" y="6" width="8" height="8"></rect>
                    </svg>
                    Stop Recording
                `;
                recordBtn.onclick = stopRecording;
                recordBtn.classList.add('bg-red-500', 'text-white');
                recordBtn.classList.remove('bg-white', 'text-purple-600');
            } else {
                recordingStatus.textContent = 'Recording completed';
            }
        }

        function updateRecordingTimer() {
            if (docMediaRecorder && docMediaRecorder.state === 'recording') {
                const elapsed = Math.floor((Date.now() - docRecordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('recordingStatus').textContent = `Recording: ${minutes}:${seconds}`;
                setTimeout(updateRecordingTimer, 1000);
            }
        }

        function simulateTranscription() {
            const analysisBox = document.getElementById('aiAnalysisBox');
            const obsText = document.getElementById('observationText');
            const obsTitle = document.getElementById('observationTitle');
            
            analysisBox.innerHTML = `<h4 class="font-semibold text-[#0D47A1] flex items-center"><svg class="animate-pulse h-5 w-5 mr-3 text-[#00A6ED]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Transcribing audio...</h4>`;
            
            setTimeout(() => {
                // Placeholder transcription result
                analysisBox.innerHTML = `
                    <h4 class="font-semibold text-[#0D47A1]">AI Audio Analysis Complete</h4>
                    <div class="bg-white border border-slate-300 rounded p-3 mt-2 text-sm">
                        <p class="font-semibold text-purple-600 mb-2">Transcription:</p>
                        <p class="text-slate-700 italic">"During the interview with the QA manager, they mentioned that the batch record review process sometimes takes longer than the 24-hour requirement. They noted that this is due to staff shortages and competing priorities."</p>
                    </div>
                    <ul class="list-disc list-inside text-sm mt-3 space-y-1 text-slate-700">
                        <li><span class="font-semibold">Key Topics Detected:</span> Batch record review, staffing issues, compliance timeline</li>
                        <li><span class="font-semibold text-amber-600">Risk Level:</span> Medium - Potential compliance gap</li>
                        <li><span class="font-semibold">Suggested Regulatory Reference:</span> 21 CFR 211.188, 211.192</li>
                    </ul>
                `;
                
                obsTitle.value = 'Batch Record Review Timeline Non-Compliance';
                obsText.value = 'During an interview with the QA Manager, it was stated that the batch record review process occasionally exceeds the required 24-hour timeframe due to staff shortages and competing priorities. This represents a potential compliance gap with established batch record review procedures.\n\nInterviewee: QA Manager\nDate: ' + new Date().toLocaleDateString() + '\nEvidence: Audio recording';
            }, 2000);
        }

        // PHOTO UPLOAD FUNCTION
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoPreviewImg = document.getElementById('photoPreviewImg');
                    photoPreviewImg.src = e.target.result;
                    
                    // Trigger AI re-analysis with new photo
                    const analysisBox = document.getElementById('aiAnalysisBox');
                    analysisBox.innerHTML = `<h4 class="font-semibold text-[#0D47A1] flex items-center"><svg class="animate-pulse h-5 w-5 mr-3 text-[#00A6ED]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Analyzing your photo...</h4>`;
                    
                    // Simulate AI analysis
                    setTimeout(() => {
                        analysisBox.innerHTML = `
                            <h4 class="font-semibold text-[#0D47A1]">AI Analysis Complete</h4>
                            <ul class="list-disc list-inside text-sm mt-2 space-y-1 text-slate-700">
                                <li><span class="font-semibold">Image Uploaded:</span> ${file.name}</li>
                                <li><span class="font-semibold">AI Vision Analysis:</span> Processing custom photo...</li>
                                <li><span class="font-semibold text-blue-600">Tip:</span> Provide a detailed description using text or voice input</li>
                            </ul>
                        `;
                    }, 1500);
                };
                reader.readAsDataURL(file);
            }
        }

        // VOICE INPUT FOR TEXT AREA - Server-side processing
        let isRecordingVoice = false;
        let voiceRecorder = null;
        let voiceChunks = [];
        let voiceStream = null;

        function toggleVoiceInput() {
            if (!isRecordingVoice) {
                startVoiceInput();
            } else {
                stopVoiceInput();
            }
        }

        async function startVoiceInput() {
            try {
                voiceStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceRecorder = new MediaRecorder(voiceStream);
                voiceChunks = [];
                
                voiceRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        voiceChunks.push(event.data);
                    }
                };
                
                voiceRecorder.onstop = async () => {
                    const audioBlob = new Blob(voiceChunks, { type: 'audio/webm' });
                    await sendAudioForTranscription(audioBlob);
                    
                    // Clean up stream
                    if (voiceStream) {
                        voiceStream.getTracks().forEach(track => track.stop());
                        voiceStream = null;
                    }
                };
                
                voiceRecorder.start();
                isRecordingVoice = true;
                
                // Update button UI
                const voiceBtn = document.getElementById('voiceInputBtn');
                voiceBtn.innerHTML = `<svg class="w-4 h-4 animate-pulse" fill="currentColor" viewBox="0 0 20 20"><rect x="6" y="6" width="8" height="8"></rect></svg>`;
                voiceBtn.classList.add('bg-red-500');
                voiceBtn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-blue-500');
                voiceBtn.title = 'Stop voice input';
            } catch (error) {
                alert('Unable to access microphone. Please check permissions.');
                console.error('Recording error:', error);
            }
        }

        function stopVoiceInput() {
            if (voiceRecorder && voiceRecorder.state !== 'inactive') {
                voiceRecorder.stop();
            }
            
            isRecordingVoice = false;
            
            const voiceBtn = document.getElementById('voiceInputBtn');
            if (voiceBtn) {
                voiceBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>`;
                voiceBtn.classList.remove('bg-red-500');
                voiceBtn.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-blue-500');
                voiceBtn.title = 'Voice input';
            }
        }

        async function sendAudioForTranscription(audioBlob) {
            const obsText = document.getElementById('observationText');
            const originalText = obsText.value;
            
            // Show loading state
            obsText.placeholder = 'Transcribing audio...';
            obsText.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice_input.webm');
                
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Append transcription to existing text
                    if (result.transcription) {
                        const separator = originalText.trim() ? ' ' : '';
                        obsText.value = originalText + separator + result.transcription;
                    } else {
                        alert('Transcription failed. Please try again.');
                    }
                } else {
                    const error = await response.json();
                    alert(`Transcription error: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Transcription error:', error);
                alert('Failed to transcribe audio. Please check your connection and try again.');
            } finally {
                // Restore input state
                obsText.placeholder = 'Describe your observation...';
                obsText.disabled = false;
                obsText.focus();
            }
        }

        // DOCUMENT GROUP FUNCTIONS
        let documentGroupCounter = 0;
        
        function toggleDocGroup(groupId) {
            const content = document.getElementById(groupId);
            const icon = document.getElementById('icon-' + groupId);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(-90deg)';
            }
        }
        
        function handleDocumentUpload(event, category) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const fileName = file.name;
            const fileSize = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            
            // Generate a random color for the placeholder
            const colors = ['0D47A1', '2D3748', '4A5568', '805AD5', '9F7AEA', '059669', '0891B2', '0284C7', 'DC2626', 'EA580C'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Determine which thumbnails container to use
            let thumbnailContainerId = '';
            if (category === 'Master Batch Records') thumbnailContainerId = 'thumbnails-mbr';
            else if (category === 'Quality System SOPs') thumbnailContainerId = 'thumbnails-qsops';
            else if (category === 'Aseptic Process SOPs') thumbnailContainerId = 'thumbnails-asops';
            else if (category === 'Executed Batch Records') thumbnailContainerId = 'thumbnails-ebr';
            else if (category === 'Previous Audit Reports') thumbnailContainerId = 'thumbnails-par';
            else if (category === 'Training Records Database') thumbnailContainerId = 'thumbnails-tr';
            else if (category === 'Environmental Monitoring Data') thumbnailContainerId = 'thumbnails-em';
            else {
                // For custom groups, find the thumbnails container by looking at the upload input's parent
                const uploadInput = event.target;
                const groupDiv = uploadInput.closest('.border');
                const thumbnails = groupDiv.querySelector('[id^="thumbnails-"]');
                thumbnailContainerId = thumbnails ? thumbnails.id : '';
            }
            
            const thumbnailsContainer = document.getElementById(thumbnailContainerId);
            if (!thumbnailsContainer) {
                alert('Error: Could not find thumbnails container');
                return;
            }
            
            // Remove "No documents" message if present
            const emptyMsg = thumbnailsContainer.querySelector('.text-center');
            if (emptyMsg) {
                thumbnailsContainer.innerHTML = '';
            }
            
            // Add new thumbnail
            const thumbnailHtml = `
                <div class="relative group">
                    <img src="https://placehold.co/100x120/${randomColor}/FFFFFF?text=${encodeURIComponent(fileName.substring(0, 10))}" 
                         alt="${fileName}" 
                         class="w-full h-20 object-cover rounded border border-slate-200">
                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-0.5 truncate text-center">${fileName}</div>
                    <button onclick="removeDocument(this)" class="absolute top-0.5 right-0.5 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            thumbnailsContainer.insertAdjacentHTML('beforeend', thumbnailHtml);
            
            // Show success message
            alert(`✓ Document "${fileName}" (${fileSize}) uploaded successfully to ${category}!`);
            
            // Reset file input
            event.target.value = '';
        }
        
        function removeDocument(button) {
            if (confirm('Are you sure you want to remove this document?')) {
                button.parentElement.remove();
            }
        }
        
        function addDocumentGroup() {
            const groupName = prompt('Enter the name for the new document group:');
            if (!groupName || groupName.trim() === '') return;
            
            documentGroupCounter++;
            const groupId = 'group-custom-' + documentGroupCounter;
            const uploadId = 'upload-custom-' + documentGroupCounter;
            const thumbnailsId = 'thumbnails-custom-' + documentGroupCounter;
            
            const newGroupHtml = `
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <div class="flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer" onclick="toggleDocGroup('${groupId}')">
                        <div class="flex items-center flex-1">
                            <svg class="w-4 h-4 mr-2 text-slate-600 transition-transform" id="icon-${groupId}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <span class="font-semibold">${groupName}</span>
                        </div>
                        <span class="text-xs text-slate-500 font-semibold">0 docs</span>
                    </div>
                    <div id="${groupId}" class="p-3 bg-white border-t border-slate-200 hidden">
                        <div class="flex gap-2 mb-3">
                            <input type="file" id="${uploadId}" class="hidden" accept=".pdf,.doc,.docx,.xlsx" onchange="handleDocumentUpload(event, '${groupName}')">
                            <button onclick="document.getElementById('${uploadId}').click()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                Upload
                            </button>
                            <button onclick="removeDocumentGroup(this)" class="bg-red-500 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-red-600 transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-4 gap-2" id="${thumbnailsId}">
                            <div class="text-center text-slate-400 text-sm py-8 col-span-4">No documents uploaded yet</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('documentStatusContent').insertAdjacentHTML('beforeend', newGroupHtml);
        }
        
        function removeDocumentGroup(button) {
            if (confirm('Are you sure you want to remove this entire document group?')) {
                button.closest('.border').remove();
            }
        }
        
        // SCOPE & STANDARDS EDIT FUNCTIONS
        let scopeOriginalContent = {};
        let isEditingScopeMode = false;
        
        function toggleScopeEdit() {
            isEditingScopeMode = !isEditingScopeMode;
            const editBtn = document.getElementById('editScopeBtn');
            const editableFields = document.querySelectorAll('.editable-field');
            const editActions = document.getElementById('scopeEditActions');
            
            if (isEditingScopeMode) {
                // Save original content before editing
                scopeOriginalContent = {
                    facility: document.getElementById('facility').innerHTML,
                    processAreas: document.getElementById('processAreas').innerHTML,
                    products: document.getElementById('products').innerHTML,
                    timePeriod: document.getElementById('timePeriod').innerHTML,
                    keySystems: document.getElementById('keySystems').innerHTML,
                    regulatoryReqs: document.getElementById('regulatoryReqs').innerHTML,
                    industryGuidelines: document.getElementById('industryGuidelines').innerHTML,
                    internalStandards: document.getElementById('internalStandards').innerHTML,
                    auditType: document.getElementById('auditType').innerHTML,
                    auditObjectives: document.getElementById('auditObjectives').innerHTML
                };
                
                // Enable editing
                editableFields.forEach(field => {
                    field.contentEditable = 'true';
                    field.classList.add('border-2', 'border-blue-300', 'bg-blue-50');
                });
                
                // Update button
                editBtn.innerHTML = `
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    Editing...
                `;
                editBtn.classList.add('bg-blue-600');
                editBtn.classList.remove('bg-slate-600');
                
                // Show edit action buttons
                editActions.classList.remove('hidden');
                
            } else {
                // Disable editing without saving
                cancelScopeEdit();
            }
        }
        
        function saveScopeChanges() {
            const editableFields = document.querySelectorAll('.editable-field');
            
            // Disable editing
            editableFields.forEach(field => {
                field.contentEditable = 'false';
                field.classList.remove('border-2', 'border-blue-300', 'bg-blue-50');
            });
            
            // Reset button
            const editBtn = document.getElementById('editScopeBtn');
            editBtn.innerHTML = `
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit
            `;
            editBtn.classList.remove('bg-blue-600');
            editBtn.classList.add('bg-slate-600');
            
            // Hide edit action buttons
            document.getElementById('scopeEditActions').classList.add('hidden');
            
            isEditingScopeMode = false;
            
            // Show success notification
            alert('✓ Scope & Standards changes saved successfully!');
        }
        
        function cancelScopeEdit() {
            // Restore original content
            if (Object.keys(scopeOriginalContent).length > 0) {
                document.getElementById('facility').innerHTML = scopeOriginalContent.facility;
                document.getElementById('processAreas').innerHTML = scopeOriginalContent.processAreas;
                document.getElementById('products').innerHTML = scopeOriginalContent.products;
                document.getElementById('timePeriod').innerHTML = scopeOriginalContent.timePeriod;
                document.getElementById('keySystems').innerHTML = scopeOriginalContent.keySystems;
                document.getElementById('regulatoryReqs').innerHTML = scopeOriginalContent.regulatoryReqs;
                document.getElementById('industryGuidelines').innerHTML = scopeOriginalContent.industryGuidelines;
                document.getElementById('internalStandards').innerHTML = scopeOriginalContent.internalStandards;
                document.getElementById('auditType').innerHTML = scopeOriginalContent.auditType;
                document.getElementById('auditObjectives').innerHTML = scopeOriginalContent.auditObjectives;
            }
            
            // Disable editing
            const editableFields = document.querySelectorAll('.editable-field');
            editableFields.forEach(field => {
                field.contentEditable = 'false';
                field.classList.remove('border-2', 'border-blue-300', 'bg-blue-50');
            });
            
            // Reset button
            const editBtn = document.getElementById('editScopeBtn');
            editBtn.innerHTML = `
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit
            `;
            editBtn.classList.remove('bg-blue-600');
            editBtn.classList.add('bg-slate-600');
            
            // Hide edit action buttons
            document.getElementById('scopeEditActions').classList.add('hidden');
            
            isEditingScopeMode = false;
        }
        
        // AI REQUIREMENT GENERATION FUNCTIONS
        const API_BASE_URL = 'http://localhost:5000/api';
        let generatedRequirements = null;
        let selectedCategory = 'all';
        
        async function generateRequirements() {
            // Collect audit scope data from the page
            const auditScope = {
                facility: document.getElementById('facility').innerText,
                process_areas: Array.from(document.getElementById('processAreas').querySelectorAll('li'))
                    .map(li => li.innerText),
                products: document.getElementById('products').innerText,
                time_period: document.getElementById('timePeriod').innerText,
                key_systems: Array.from(document.getElementById('keySystems').querySelectorAll('li'))
                    .map(li => li.innerText),
                regulatory_requirements: Array.from(document.getElementById('regulatoryReqs').querySelectorAll('li'))
                    .map(li => li.innerText)
            };
            
            // Show loading state
            document.getElementById('reqEmptyState').classList.add('hidden');
            document.getElementById('reqDisplayArea').classList.add('hidden');
            document.getElementById('reqErrorState').classList.add('hidden');
            document.getElementById('reqLoadingState').classList.remove('hidden');
            document.getElementById('generateReqBtn').disabled = true;
            
            try {
                // Call backend API
                const response = await fetch(`${API_BASE_URL}/generate-requirements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(auditScope)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                generatedRequirements = data;
                
                // Display requirements
                displayRequirements(data);
                
                // Hide loading, show display
                document.getElementById('reqLoadingState').classList.add('hidden');
                document.getElementById('reqDisplayArea').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error generating requirements:', error);
                
                // Show error state
                document.getElementById('reqLoadingState').classList.add('hidden');
                document.getElementById('reqErrorState').classList.remove('hidden');
                document.getElementById('reqErrorMessage').innerText = 
                    `Failed to generate requirements: ${error.message}`;
            } finally {
                document.getElementById('generateReqBtn').disabled = false;
            }
        }
        
        function displayRequirements(data) {
            // Update total count
            document.getElementById('reqTotalCount').innerText = data.total_requirements || 0;
            
            // Create category tabs
            const tabsContainer = document.getElementById('reqCategoryTabs');
            tabsContainer.innerHTML = '';
            
            // Add "All" tab
            const allTab = document.createElement('button');
            allTab.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-purple-600 text-white';
            allTab.innerText = `All (${data.total_requirements})`;
            allTab.onclick = () => filterRequirements('all');
            tabsContainer.appendChild(allTab);
            
            // Add category tabs
            if (data.categories) {
                data.categories.forEach(cat => {
                    const tab = document.createElement('button');
                    tab.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-slate-200 text-slate-700 hover:bg-slate-300';
                    tab.innerText = `${cat.category_name} (${cat.requirement_count})`;
                    tab.onclick = () => filterRequirements(cat.category_name);
                    tab.dataset.category = cat.category_name;
                    tabsContainer.appendChild(tab);
                });
            }
            
            // Display all requirements initially
            filterRequirements('all');
        }
        
        function filterRequirements(category) {
            selectedCategory = category;
            
            // Update tab styles
            const tabs = document.querySelectorAll('#reqCategoryTabs button');
            tabs.forEach(tab => {
                if ((category === 'all' && tab.innerText.startsWith('All')) || 
                    tab.dataset.category === category) {
                    tab.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-purple-600 text-white';
                } else {
                    tab.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-slate-200 text-slate-700 hover:bg-slate-300';
                }
            });
            
            // Filter and display requirements
            const reqList = document.getElementById('reqList');
            reqList.innerHTML = '';
            
            if (!generatedRequirements || !generatedRequirements.categories) return;
            
            generatedRequirements.categories.forEach(cat => {
                if (category !== 'all' && cat.category_name !== category) return;
                
                cat.requirements.forEach(req => {
                    const reqCard = createRequirementCard(req);
                    reqList.appendChild(reqCard);
                });
            });
        }
        
        function createRequirementCard(req) {
            const card = document.createElement('div');
            card.className = 'border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white';
            
            const riskColors = {
                'Critical': 'bg-red-100 text-red-800 border-red-300',
                'High': 'bg-orange-100 text-orange-800 border-orange-300',
                'Medium': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'Low': 'bg-blue-100 text-blue-800 border-blue-300'
            };
            
            // Handle both old and new field names
            const requirementText = req['requirement_text (verbatim)'] || req.requirement_text || '';
            const auditFocus = req.suggested_audit_focus || req.audit_focus || '';
            const citation = req.citation || extractCitation(requirementText);
            
            // Parse compliance evidence (handle both array of strings and numbered strings)
            const complianceEvidence = Array.isArray(req.compliance_evidence) 
                ? req.compliance_evidence 
                : [];
            
            // Parse common gaps (handle both array of strings and numbered strings)
            const commonGaps = Array.isArray(req.common_gaps) 
                ? req.common_gaps 
                : [];
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="text-xs font-mono text-slate-500">${req.id || 'N/A'}</span>
                        <span class="ml-2 px-2 py-0.5 text-xs rounded-full border ${riskColors[req.risk_level] || riskColors.Medium}">
                            ${req.risk_level || 'Medium'}
                        </span>
                        ${req.category ? `<span class="ml-2 text-xs text-slate-500">${req.category}</span>` : ''}
                    </div>
                    <button onclick="toggleRequirementDetails('${req.id}')" class="text-slate-400 hover:text-slate-600">
                        <svg id="toggle-${req.id}" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-2">
                    <span class="text-xs font-semibold text-purple-600">${citation}</span>
                    ${req.regulation_name ? `<span class="text-xs text-slate-500 ml-2">${req.regulation_name}</span>` : ''}
                </div>
                
                <p class="text-sm text-slate-700 font-medium mb-3">${cleanRequirementText(requirementText)}</p>
                
                <div id="details-${req.id}" class="hidden space-y-3 pt-3 border-t border-slate-200">
                    ${complianceEvidence.length > 0 ? `
                    <div>
                        <h6 class="text-xs font-semibold text-slate-700 mb-1">Compliance Evidence:</h6>
                        <ul class="list-disc list-inside text-xs text-slate-600 space-y-1">
                            ${complianceEvidence.map(e => `<li>${cleanListItem(e)}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${commonGaps.length > 0 ? `
                    <div>
                        <h6 class="text-xs font-semibold text-slate-700 mb-1">Common Gaps:</h6>
                        <ul class="list-disc list-inside text-xs text-slate-600 space-y-1">
                            ${commonGaps.map(g => `<li>${cleanListItem(g)}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${auditFocus ? `
                    <div class="bg-purple-50 rounded p-2">
                        <h6 class="text-xs font-semibold text-purple-700 mb-1">Suggested Audit Focus:</h6>
                        <p class="text-xs text-purple-600">${auditFocus}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            return card;
        }
        
        function extractCitation(text) {
            // Extract citation from **citation** format
            const match = text.match(/\*\*(.+?)\*\*/);
            return match ? match[1] : '';
        }
        
        function cleanRequirementText(text) {
            // Remove **citation** markers from requirement text
            return text.replace(/\*\*(.+?)\*\*/g, '');
        }
        
        function cleanListItem(item) {
            // Remove leading numbers like "1. " or "2. " from list items
            if (typeof item === 'string') {
                return item.replace(/^\d+\.\s*/, '');
            }
            return item;
        }
        
        function toggleRequirementDetails(reqId) {
            const details = document.getElementById(`details-${reqId}`);
            const icon = document.getElementById(`toggle-${reqId}`);
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function exportRequirements() {
            if (!generatedRequirements) {
                alert('No requirements to export');
                return;
            }
            
            // Export as JSON
            const dataStr = JSON.stringify(generatedRequirements, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'audit_requirements.json';
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // FOCUS AREAS FUNCTIONS
        function renderFocusAreas() {
            const container = document.getElementById('focusAreasContainer');
            if (!container) return;
            
            const filteredAreas = currentFocusFilter === 'all' 
                ? focusAreas 
                : focusAreas.filter(area => area.risk === currentFocusFilter);
            
            if (filteredAreas.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No findings in this category</p>';
                return;
            }
            
            container.innerHTML = filteredAreas.map(area => {
                const riskColors = {
                    'critical': { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800', icon: '🔴' },
                    'high': { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-800', icon: '🟡' },
                    'medium': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800', icon: '🔵' }
                };
                
                const colors = riskColors[area.risk];
                const sourcesHtml = area.sources.map(src => `<span class="inline-block bg-white px-2 py-1 rounded text-xs">${src}</span>`).join(' ');
                const regsHtml = area.regulations.map(reg => `<span class="inline-block bg-slate-200 text-slate-800 px-2 py-1 rounded-full text-xs">${reg}</span>`).join(' ');
                
                return `
                    <div class="focus-area-card ${area.risk} bg-white rounded-lg shadow-sm border ${colors.border}" onclick="toggleFocusArea(${area.id})" id="focus-${area.id}">
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">${colors.icon}</span>
                                        <span class="text-xs font-bold ${colors.text} uppercase tracking-wider">${area.risk} Risk</span>
                                    </div>
                                    <h4 class="font-bold text-slate-800 mb-1">${area.title}</h4>
                                    <p class="text-sm text-slate-600">${area.description}</p>
                                </div>
                                <button class="ml-4 text-slate-400 hover:text-slate-600 focus-expand-icon">
                                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Expanded Details -->
                            <div class="focus-area-details mt-4 pt-4 border-t border-slate-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h5 class="font-semibold text-xs text-slate-500 mb-2">Source Documents</h5>
                                        <div class="flex flex-wrap gap-1">
                                            ${sourcesHtml}
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-xs text-slate-500 mb-2">Applicable Regulations</h5>
                                        <div class="flex flex-wrap gap-1">
                                            ${regsHtml}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h5 class="font-semibold text-xs text-slate-500 mb-1">Impact Area</h5>
                                    <p class="text-sm text-slate-700">${area.impact}</p>
                                </div>
                                <div class="mb-4">
                                    <h5 class="font-semibold text-xs text-slate-500 mb-1">Recommendation</h5>
                                    <p class="text-sm text-slate-700 ${colors.bg} p-3 rounded">${area.recommendation}</p>
                                </div>
                                <div class="flex gap-2">
                                    ${auditPlanItems.find(item => item.focusAreaId === area.id) ? 
                                        `<button class="text-xs font-semibold px-3 py-2 rounded bg-green-600 text-white cursor-default" disabled>
                                            ✓ Added to Audit Plan
                                        </button>` :
                                        `<button class="text-xs font-semibold px-3 py-2 rounded bg-[#0D47A1] text-white hover:bg-opacity-90" onclick="addToAuditPlan(${area.id}, event)">
                                            + Add to Audit Plan
                                        </button>`
                                    }
                                    <button class="text-xs font-semibold px-3 py-2 rounded bg-slate-200 text-slate-700 hover:bg-slate-300" onclick="viewSourceDocuments(${area.id}, event)">
                                        📄 View Sources
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleFocusArea(id) {
            const card = document.getElementById(`focus-${id}`);
            const icon = card.querySelector('.focus-expand-icon svg');
            
            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                icon.style.transform = 'rotate(0deg)';
            } else {
                card.classList.add('expanded');
                icon.style.transform = 'rotate(180deg)';
            }
        }
        
        function filterFocusAreas(filter) {
            currentFocusFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.filter-btn, .filter-btn-active').forEach(btn => {
                btn.classList.remove('filter-btn-active');
                btn.classList.add('filter-btn');
                btn.classList.remove('bg-slate-700', 'text-white');
                btn.classList.add('bg-slate-200', 'text-slate-700');
            });
            
            const activeBtn = document.getElementById(`filter-${filter}`);
            if (activeBtn) {
                activeBtn.classList.add('filter-btn-active');
                activeBtn.classList.remove('filter-btn');
                activeBtn.classList.remove('bg-slate-200', 'text-slate-700');
                activeBtn.classList.add('bg-slate-700', 'text-white');
            }
            
            renderFocusAreas();
        }
        
        function addToAuditPlan(id, event) {
            event.stopPropagation();
            
            // Check if already added
            if (auditPlanItems.find(item => item.focusAreaId === id)) {
                alert('This item is already in your audit plan!');
                return;
            }
            
            const area = focusAreas.find(a => a.id === id);
            
            // Create audit plan item
            const planItem = {
                focusAreaId: id,
                title: area.title,
                description: area.description,
                risk: area.risk,
                sources: area.sources,
                regulations: area.regulations,
                impact: area.impact,
                recommendation: area.recommendation,
                agendaId: '2.0', // Add to QMS & Doc Review section
                addedDate: new Date().toLocaleDateString()
            };
            
            auditPlanItems.push(planItem);
            
            // Show success message
            const successMsg = `✓ Added to Audit Plan!\n\n"${area.title}"\n\nThis will appear in the QMS & Doc Review section during Live Fieldwork.`;
            alert(successMsg);
            
            // Re-render focus areas to update button states
            renderFocusAreas();
            
            // Update fieldwork tab if it's currently active
            if (currentTab === 'fieldwork') {
                renderEvidence('2.0');
            }
        }
        
        function viewSourceDocuments(id, event) {
            event.stopPropagation();
            const area = focusAreas.find(a => a.id === id);
            alert(`Source Documents for: ${area.title}\n\n${area.sources.join('\n')}\n\nClick on documents in the gallery below to view them.`);
        }

        // FIELDWORK TAB LOGIC
        function renderFieldworkTab() { renderAgenda(); }
        function renderAgenda() {
            const list = document.getElementById('agendaList');
            list.innerHTML = `<a href="javascript:void(0)" onclick="selectAgendaItem(this, '1.0')" class="block p-3 rounded-lg border-l-4">1.0 - Opening Meeting</a><a href="javascript:void(0)" onclick="selectAgendaItem(this, '2.0')" class="block p-3 rounded-lg border-l-4">2.0 - QMS & Doc Review</a><a href="javascript:void(0)" onclick="selectAgendaItem(this, '3.0')" class="block p-3 rounded-lg border-l-4">3.0 - Facility Tour</a><div class="pl-6 space-y-2"><a href="javascript:void(0)" onclick="selectAgendaItem(this, '3.1')" class="block p-2 rounded-lg text-sm">3.1 - Gowning & Material Airlock</a><a href="javascript:void(0)" onclick="selectAgendaItem(this, '3.2')" class="block p-2 rounded-lg text-sm">3.2 - Aseptic Filling Suite (Line 2)</a><a href="javascript:void(0)" onclick="selectAgendaItem(this, '3.3')" class="block p-2 rounded-lg text-sm">3.3 - QC Microbiology Lab</a></div><a href="javascript:void(0)" onclick="selectAgendaItem(this, '4.0')" class="block p-3 rounded-lg border-l-4">4.0 - End of Day Debrief</a>`;
            selectAgendaItem(list.querySelector(`a[onclick*="'${currentAgendaId}'"]`), currentAgendaId);
        }
        function selectAgendaItem(element, agendaId) {
            currentAgendaId = agendaId;
            document.querySelectorAll('#agendaList a').forEach(a => a.classList.remove('active-agenda', 'active-sub-agenda'));
            if(element.parentElement.classList.contains('pl-6')) { element.classList.add('active-sub-agenda'); element.closest('.space-y-2').previousElementSibling.classList.add('active-agenda'); } 
            else { element.classList.add('active-agenda'); }
            document.getElementById('evidenceViewTitle').innerText = `Evidence for ${agendaMap[agendaId]}`;
            renderEvidence(agendaId);
        }
        function renderEvidence(agendaId) {
            const list = document.getElementById('evidenceList');
            const filteredData = auditData.filter(item => item.agendaId === agendaId);
            
            // Add audit plan items to QMS & Doc Review section
            let planItemsForSection = [];
            if (agendaId === '2.0') {
                planItemsForSection = auditPlanItems.filter(item => item.agendaId === agendaId);
            }
            
            if (filteredData.length === 0 && planItemsForSection.length === 0) { 
                list.innerHTML = '<div class="bg-slate-100 p-4 rounded-lg text-center text-slate-500">No evidence captured for this section.</div>'; 
                return; 
            }
            // Render audit plan items first (for QMS & Doc Review section)
            const planItemsHtml = planItemsForSection.map(planItem => {
                const riskColors = {
                    'critical': { border: 'border-red-500', bg: 'bg-red-50', text: 'text-red-800', icon: '🔴' },
                    'high': { border: 'border-amber-500', bg: 'bg-amber-50', text: 'text-amber-800', icon: '🟡' },
                    'medium': { border: 'border-blue-500', bg: 'bg-blue-50', text: 'text-blue-800', icon: '🔵' }
                };
                const colors = riskColors[planItem.risk];
                
                return `
                    <div class="bg-white p-4 rounded-lg shadow-md border-l-4 ${colors.border} ${colors.bg}">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${colors.icon}</span>
                                <h3 class="font-bold text-lg text-slate-700">${planItem.title}</h3>
                            </div>
                            <span class="text-xs font-semibold bg-purple-100 text-purple-800 px-2 py-1 rounded-full">Audit Plan Item</span>
                        </div>
                        <p class="text-slate-600 mb-3">${planItem.description}</p>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <span class="font-semibold text-slate-500">Impact:</span>
                                <p class="text-slate-700">${planItem.impact}</p>
                            </div>
                            <div>
                                <span class="font-semibold text-slate-500">Added:</span>
                                <p class="text-slate-700">${planItem.addedDate}</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <span class="font-semibold text-xs text-slate-500">Action Items:</span>
                            <p class="text-xs text-slate-700 mt-1">${planItem.recommendation}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render regular audit data items
            const auditDataHtml = filteredData.map(item => {
                if (item.type === 'Note') {
                    return `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-sky-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <h3 class="font-bold text-lg text-sky-800">${item.title}</h3>
                            </div>
                            <p class="text-slate-600 text-sm">${item.text}</p>
                        </div>
                    `;
                }
                
                // Observation cards with severity-based styling
                const severityColors = {
                    'Minor': { border: 'border-blue-500', bg: 'bg-blue-50', text: 'text-blue-800', icon: '🔵', badgeBg: 'bg-blue-100', badgeText: 'text-blue-800' },
                    'Major': { border: 'border-amber-500', bg: 'bg-amber-50', text: 'text-amber-800', icon: '🟡', badgeBg: 'bg-amber-100', badgeText: 'text-amber-800' },
                    'Critical': { border: 'border-red-500', bg: 'bg-red-50', text: 'text-red-800', icon: '🔴', badgeBg: 'bg-red-100', badgeText: 'text-red-800' },
                    'Draft': { border: 'border-slate-300', bg: 'bg-slate-50', text: 'text-slate-700', icon: '📝', badgeBg: 'bg-slate-200', badgeText: 'text-slate-600' }
                };
                
                const statusClass = item.status === 'Draft' ? 'Draft' : item.severity;
                const colors = severityColors[statusClass] || severityColors['Draft'];
                const statusLabel = item.status === 'Draft' ? 'Draft' : 'Finalized';
                const statusBadgeColor = item.status === 'Draft' ? 'bg-slate-200 text-slate-600' : 'bg-green-100 text-green-800';
                
                const evidenceHtml = item.evidence.map(e => 
                    `<img src="${e.src}" alt="${e.alt}" class="w-16 h-16 bg-slate-700 rounded-md object-cover">`
                ).join('');
                
                return `
                    <div onclick="openObservationDetails(${item.id})" id="obs-${item.id}" 
                         class="bg-white p-4 rounded-lg shadow-sm border ${colors.border} hover:shadow-md transition-all cursor-pointer">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2 flex-1">
                                <span class="text-lg">${colors.icon}</span>
                                <h3 class="font-bold text-lg text-slate-700">${item.title}</h3>
                            </div>
                            <div class="flex gap-2 ml-2">
                                ${item.status === 'Draft' ? '' : `<span class="text-xs font-semibold ${colors.badgeBg} ${colors.badgeText} px-2 py-1 rounded-full">${item.severity}</span>`}
                                <span class="text-xs font-semibold ${statusBadgeColor} px-2 py-1 rounded-full">${statusLabel}</span>
                            </div>
                        </div>
                        <p class="text-slate-600 text-sm mb-3">${item.text}</p>
                        ${evidenceHtml ? `
                            <div class="flex items-center gap-2 pt-3 border-t border-slate-200">
                                <span class="text-xs font-semibold text-slate-500">Evidence:</span>
                                <div class="flex items-center gap-2">${evidenceHtml}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // Combine plan items and audit data
            list.innerHTML = planItemsHtml + auditDataHtml;
        }

        // FINALIZATION TAB LOGIC
        function renderFinalizationTab() {
            const counts = auditData.reduce((acc, item) => { if (item.type === 'Observation') { if (item.status === 'Draft') acc.draft++; else if (item.severity) acc[item.severity.toLowerCase()]++; } return acc; }, { critical: 0, major: 0, minor: 0, draft: 0 });
            document.getElementById('criticalCount').textContent = counts.critical;
            document.getElementById('majorCount').textContent = counts.major;
            document.getElementById('minorCount').textContent = counts.minor;
            document.getElementById('draftCount').textContent = counts.draft;
            const summaryText = `A Good Manufacturing Practices (GMP) audit of the PharmaCore Aseptic Filling facility at Site C was conducted from September 29-30, 2025.\n\nThe audit concludes with a rating of 'Acceptable with Conditions'.\n\nWhile the Quality Management System was found to be generally functional, the audit identified three Major observations that require immediate attention. These include a critical breach of aseptic technique during filling operations on Line 2, a statistically significant adverse trend in environmental monitoring particle counts in the Grade B area, and a damaged gasket on a critical material transfer hatch compromising the cleanroom cascade.\n\nAdditionally, two Minor observations were noted related to documentation control and training compliance.\n\nRobust Corrective and Preventive Actions (CAPAs) must be implemented to address the systemic risks identified to ensure the continued state of control and sterility assurance of products manufactured at the facility.`;
            document.getElementById('executiveSummary').value = summaryText;
            checkReportReady();
            renderFindingsChart(counts);
        }
        function renderFindingsChart(counts) {
            const ctx = document.getElementById('findingsChart').getContext('2d');
            if (findingsChartInstance) findingsChartInstance.destroy();
            findingsChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Minor', 'Major', 'Critical'], datasets: [{ data: [counts.minor, counts.major, counts.critical], backgroundColor: ['#81D4FA', '#FBBF24', '#F87171'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }
        function selectGrade(element) { document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('selected')); element.classList.add('selected'); checkReportReady(); }
        document.getElementById('executiveSummary').addEventListener('input', checkReportReady);
        function checkReportReady() {
            const draftCount = auditData.filter(i => i.type === 'Observation' && i.status === 'Draft').length;
            const gradeSelected = !!document.querySelector('.grade-btn.selected');
            const summaryWritten = document.getElementById('executiveSummary').value.length > 20;
            const reportBtn = document.getElementById('generateReportBtn');
            const helper = document.getElementById('reportHelper');
            let unmetConditions = [];
            if (draftCount > 0) unmetConditions.push(`finalize ${draftCount} draft observation(s)`);
            if (!gradeSelected) unmetConditions.push("assign a grade");
            if (!summaryWritten) unmetConditions.push("write an executive summary");
            if (unmetConditions.length === 0) {
                reportBtn.disabled = false;
                helper.textContent = "Ready to generate report.";
                helper.classList.remove('text-amber-600');
                helper.classList.add('text-green-600');
            } else {
                reportBtn.disabled = true;
                helper.textContent = `To enable, you must: ${unmetConditions.join(', ')}.`;
                helper.classList.remove('text-green-600');
                helper.classList.add('text-amber-600');
            }
        }
        
        // MODAL & DATA LOGIC
        function openCaptureModal() {
             const modalContainer = document.getElementById('modalContainer');
             modalContainer.innerHTML = `<div id="captureModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50"><div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[98vh] flex flex-col"><header class="p-4 border-b flex justify-between items-center shrink-0"><h2 class="text-xl font-bold text-[#0D47A1]">New Observation Workflow</h2><button onclick="closeAllModals()" class="text-slate-500 hover:text-red-500 text-3xl">&times;</button></header><div id="captureStep1" class="p-8 flex-grow overflow-y-auto"><h3 class="font-semibold text-lg mb-2">Step 1: Select Evidence Type</h3><p class="text-slate-600 mb-6">How are you capturing this finding? This will tailor the assistance.</p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><button onclick="startCapture('photo')" class="text-left flex flex-col p-6 bg-slate-50 hover:bg-sky-100 rounded-lg border-2 border-dashed hover:border-sky-400 transition-all"><div class="flex items-center mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#00A6ED] mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span class="font-bold text-lg">Photo / Visual</span></div><p class="text-sm text-slate-500 mt-1">Physical findings, facility damage, or equipment issues.</p></button><button onclick="startCapture('audio')" class="text-left flex flex-col p-6 bg-slate-50 hover:bg-sky-100 rounded-lg border-2 border-dashed hover:border-sky-400 transition-all"><div class="flex items-center mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#00A6ED] mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg><span class="font-bold text-lg">Audio Recording</span></div><p class="text-sm text-slate-500 mt-1">Interview recordings, verbal observations, or voice notes.</p></button><button onclick="startCapture('doc')" class="text-left flex flex-col p-6 bg-slate-50 hover:bg-sky-100 rounded-lg border-2 border-dashed hover:border-sky-400 transition-all"><div class="flex items-center mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#00A6ED] mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M16 19h6"/></svg><span class="font-bold text-lg">Document Review</span></div><p class="text-sm text-slate-500 mt-1">Findings in logbooks, batch records, or SOPs.</p></button><button onclick="startCapture('manual')" class="text-left flex flex-col p-6 bg-slate-50 hover:bg-sky-100 rounded-lg border-2 border-dashed hover:border-sky-400 transition-all"><div class="flex items-center mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#00A6ED] mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg><span class="font-bold text-lg">Manual Written</span></div><p class="text-sm text-slate-500 mt-1">Process observations or interview findings.</p></button></div></div><div id="captureStep2" class="p-8 flex-grow overflow-y-auto hidden"></div></div></div>`;
        }
        function startCapture(type) {
            document.getElementById('captureStep1').classList.add('hidden');
            const step2 = document.getElementById('captureStep2');
            step2.innerHTML = `<h3 class="font-semibold text-lg mb-4">Step 2: Draft Your Observation</h3><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="font-semibold text-sm">Evidence</label><div class="mt-1 border-4 border-slate-300 rounded-lg p-1"><div id="evidencePreview" class="w-full h-48 bg-slate-700 text-white flex items-center justify-center text-center p-4 rounded text-lg"></div></div></div><div id="aiAnalysisBox" class="bg-sky-50 border border-sky-200 rounded-lg p-4"></div></div><div class="space-y-4"><div><label for="observationTitle" class="block font-semibold text-sm mb-1">Observation Title</label><input type="text" id="observationTitle" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#00A6ED]"></div><div><label for="observationText" class="block font-semibold text-sm mb-1 flex items-center justify-between">
                    <span>Observation Description</span>
                    <span class="text-xs text-slate-500 font-normal">Type or use voice input</span>
                </label><div class="relative"><textarea id="observationText" rows="6" class="w-full p-2 pr-12 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#00A6ED]" placeholder="Describe your observation..."></textarea><div class="absolute right-2 bottom-2 flex gap-1"><button id="voiceInputBtn" onclick="toggleVoiceInput()" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white p-2 rounded-lg hover:from-purple-600 hover:to-blue-600 transition-all shadow-sm" title="Voice input"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></button></div></div></div><div><label class="block font-semibold text-sm mb-1">Link Relevant Clauses</label><div id="aiClauseSuggestions" class="flex flex-wrap gap-2"></div></div></div></div><footer class="p-4 bg-slate-50 border-t flex justify-end shrink-0 -mx-8 -mb-8 mt-8"><button onclick="saveDraft()" class="bg-[#0D47A1] text-white font-bold px-6 py-2 rounded-lg hover:bg-opacity-90">Save as Draft Observation</button></footer>`;
            step2.classList.remove('hidden');
            runAiAnalysis(type);
        }
        function runAiAnalysis(type) {
            const preview = document.getElementById('evidencePreview');
            const analysisBox = document.getElementById('aiAnalysisBox');
            const obsTitle = document.getElementById('observationTitle');
            const obsText = document.getElementById('observationText');
            const clauses = document.getElementById('aiClauseSuggestions');
            analysisBox.innerHTML = `<h4 class="font-semibold text-[#0D47A1] flex items-center"><svg class="animate-pulse h-5 w-5 mr-3 text-[#00A6ED]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Aura AI is analyzing...</h4>`;
            setTimeout(() => {
                if (type === 'audio') {
                    preview.innerHTML = `
                        <div class="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-purple-600 to-blue-600 rounded-sm p-4">
                            <svg class="h-16 w-16 text-white mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                            <p class="text-white font-semibold mb-2">Audio Recording</p>
                            <div class="flex items-center gap-2">
                                <button id="recordBtn" onclick="startRecording()" class="bg-white text-purple-600 px-4 py-2 rounded-full font-semibold text-sm hover:bg-slate-100 flex items-center gap-2">
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                        <circle cx="10" cy="10" r="5"></circle>
                                    </svg>
                                    Start Recording
                                </button>
                            </div>
                            <p class="text-white text-xs mt-2" id="recordingStatus">Ready to record</p>
                            <audio id="audioPlayback" controls class="mt-3 hidden w-full"></audio>
                        </div>
                    `;
                    analysisBox.innerHTML = `<h4 class="font-semibold text-[#0D47A1]">AI Audio Analysis</h4><ul class="list-disc list-inside text-sm mt-2 space-y-1 text-slate-700"><li><span class="font-semibold">Speech-to-Text:</span> Ready to transcribe audio recording</li><li><span class="font-semibold">Sentiment Analysis:</span> Will analyze tone and context</li><li class="font-semibold text-blue-600">AI Assistant:</span> Will suggest observation details based on audio content</li></ul><p class="text-xs text-slate-500 mt-3">Click "Start Recording" to begin capturing audio evidence.</p>`;
                    obsTitle.value = 'Audio Observation';
                    obsText.value = 'Record your observation using the microphone. AI will transcribe and analyze the content.';
                    clauses.innerHTML = ['21 CFR 211', 'EU GMP', 'Interview Protocol'].map(tag => `<button class="bg-slate-200 text-slate-700 text-sm px-3 py-1 rounded-full hover:bg-sky-200">${tag}</button>`).join('');
                } else if (type === 'photo') {
                    preview.innerHTML = `
                        <div class="w-full h-full flex flex-col bg-slate-100 rounded-sm overflow-hidden">
                            <div id="photoDisplayArea" class="flex-1 bg-slate-700 flex items-center justify-center">
                                <img id="photoPreviewImg" src="https://images.unsplash.com/photo-1599599810694-b5b37306c844?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover">
                            </div>
                            <div class="p-2 bg-slate-800 flex items-center justify-between">
                                <label class="cursor-pointer bg-white text-slate-800 px-3 py-1.5 rounded text-xs font-semibold hover:bg-slate-100 flex items-center gap-1.5">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    Upload Photo
                                    <input type="file" id="photoUploadInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                                </label>
                                <span class="text-white text-xs">Sample Photo (Click to upload yours)</span>
                            </div>
                        </div>
                    `;
                    analysisBox.innerHTML = `<h4 class="font-semibold text-[#0D47A1]">AI Analysis Complete</h4><ul class="list-disc list-inside text-sm mt-2 space-y-1 text-slate-700"><li><span class="font-semibold">Object Detected:</span> Floor Tile, Crack, Grade C Corridor</li><li class="font-semibold text-red-600">Risk Flagged:</span> Not easily cleanable/sanitizable surface. Potential for microbial contamination.</li></ul>`;
                    obsTitle.value = 'Damaged Floor Tile in Grade C Corridor';
                    obsText.value = 'A floor tile located near the entrance to the Grade C corridor was observed to be cracked. This compromises the integrity of the surface, making it difficult to effectively clean and sanitize, and posing a contamination risk to the classified area.';
                    clauses.innerHTML = ['21 CFR 211.67(a)', 'EU GMP Annex 1', 'SOP-FAC-005'].map(tag => `<button class="bg-slate-200 text-slate-700 text-sm px-3 py-1 rounded-full hover:bg-sky-200">${tag}</button>`).join('');
                } else if (type === 'doc') {
                    preview.innerHTML = `<img src="https://placehold.co/600x400/334155/FFFFFF?text=Logbook+LOG-CLN-004" class="w-full h-full object-cover rounded-sm">`;
                    analysisBox.innerHTML = `<h4 class="font-semibold text-[#0D47A1]">AI Analysis Complete</h4><ul class="list-disc list-inside text-sm mt-2 space-y-1 text-slate-700"><li><span class="font-semibold">OCR Data:</span> "Cleaned by J. Doe", "Date: 29-SEP-2025"</li><li><span class="font-semibold">Rule Check (SOP-CLN-010):</span> Verification signature required.</li><li class="font-semibold text-amber-600">Discrepancy:</span> Verifier signature field is empty.</li></ul>`;
                    obsTitle.value = 'Missing Verification Signature in Cleaning Log';
                    obsText.value = 'The cleaning logbook for the parts washer (LOG-CLN-004) for the activity performed on 29-SEP-2025 by J. Doe was found to be missing the required second signature for verification, as stipulated in SOP-CLN-010. This is a data integrity failure.';
                    clauses.innerHTML = ['21 CFR 211.188 (ALCOA+)', 'SOP-CLN-010'].map(tag => `<button class="bg-slate-200 text-slate-700 text-sm px-3 py-1 rounded-full hover:bg-sky-200">${tag}</button>`).join('');
                } else { // manual
                    preview.innerText = '[Manual Observation]';
                    analysisBox.innerHTML = `<h4 class="font-semibold text-[#0D47A1]">Manual Entry</h4><p class="text-sm mt-2 text-slate-600">AI assistance is not applicable for this observation type. Please document your finding based on your professional judgment.</p>`;
                    obsTitle.value = ''; obsText.value = '';
                    clauses.innerHTML = `<span class="text-xs text-slate-400">Enter clauses manually if needed.</span>`;
                }
            }, 1000);
        }
        function saveDraft() {
            const newObservation = {id: nextObservationId++, agendaId: currentAgendaId, type: 'Observation', title: document.getElementById('observationTitle').value, text: document.getElementById('observationText').value, status: 'Draft', severity: null, evidence: [{type:'manual', src: `https://placehold.co/600x400/334155/FFFFFF?text=${encodeURIComponent(document.getElementById('evidencePreview').innerText)}`, alt: 'Manual Observation'}], regulations:[], capaRecommendation:"To be determined."};
            auditData.push(newObservation);
            renderEvidence(currentAgendaId);
            closeAllModals();
        }
        function openFinalizeModal(id) {
            observationToFinalizeId = id;
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `<div id="finalizeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md"><header class="p-4 border-b"><h2 class="text-xl font-bold text-[#0D47A1]">Finalize Observation</h2></header><div class="p-6"><p class="mb-4">Select a severity. This action cannot be undone.</p><div class="flex flex-col space-y-2"><button onclick="confirmFinalization('Minor')" class="text-left w-full p-3 font-semibold bg-sky-100 text-sky-800 rounded-lg hover:bg-sky-200">Minor</button><button onclick="confirmFinalization('Major')" class="text-left w-full p-3 font-semibold bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200">Major</button><button onclick="confirmFinalization('Critical')" class="text-left w-full p-3 font-semibold bg-red-100 text-red-800 rounded-lg hover:bg-red-200">Critical</button></div></div><footer class="p-4 bg-slate-50 border-t flex justify-end"><button onclick="closeAllModals()" class="bg-slate-200 px-4 py-2 rounded-lg text-sm font-semibold">Cancel</button></footer></div></div>`;
        }
        function confirmFinalization(severity) {
            const item = auditData.find(d => d.id === observationToFinalizeId);
            if (item) { item.status = 'Finalized'; item.severity = severity; }
            closeAllModals();
            if (currentTab === 'fieldwork') renderEvidence(item.agendaId);
            else if (currentTab === 'finalization') renderFinalizationTab();
        }
        function generateReport() {
            const modalContainer = document.getElementById('modalContainer');
            const gradeEl = document.querySelector('.grade-btn.selected');
            if (!gradeEl) { alert('Please select a grade first.'); return; }
            const grade = gradeEl.innerText.split('\n')[1].trim();
            const gradeColor = grade.includes('Conditions') ? 'amber' : grade === 'Acceptable' ? 'green' : 'red';
            const summary = document.getElementById('executiveSummary').value;
            const finalizedFindings = auditData.filter(item => item.type === 'Observation' && item.status === 'Finalized');
            const draftCount = auditData.filter(item => item.type === 'Observation' && item.status === 'Draft').length;
            const findingsHtml = finalizedFindings.map(item => {
                const severityClass = item.severity === 'Major' ? 'amber' : item.severity === 'Critical' ? 'red' : 'sky';
                const evidenceHtml = item.evidence.map(e => `<img src="${e.src}" alt="${e.alt}" class="w-24 h-24 object-cover rounded-md bg-slate-200">`).join('');
                 const regulationsHtml = item.regulations.map(r => `<div class="mt-2"><span class="bg-slate-200 text-slate-800 text-xs font-semibold px-2 py-1 rounded-full">${r.id}</span><p class="text-xs text-slate-500 mt-1 pl-1">${r.justification}</p></div>`).join('');
                return `<div class="mb-6 pb-6 border-b last:border-b-0">
                            <h4 class="font-bold text-lg flex items-center">${item.title} 
                                <span class="ml-auto text-sm font-semibold bg-${severityClass}-100 text-${severityClass}-800 px-3 py-1 rounded-full">${item.severity}</span>
                            </h4>
                            <p class="mt-2 text-slate-600">${item.text}</p>
                            <div class="mt-4">
                                <h5 class="font-semibold text-sm text-slate-500 mb-2">Evidence</h5>
                                <div class="flex flex-wrap gap-2">${evidenceHtml}</div>
                            </div>
                            <div class="mt-4">
                                <h5 class="font-semibold text-sm text-slate-500 mb-2">Relevant Regulations & SOPs</h5>
                                <div class="space-y-2">${regulationsHtml}</div>
                            </div>
                            <div class="mt-4">
                                <h5 class="font-semibold text-sm text-slate-500 mb-2">Recommended CAPA Plan</h5>
                                <p class="text-sm text-slate-700 bg-slate-50 p-3 rounded-md">${item.capaRecommendation}</p>
                            </div>
                        </div>`;
            }).join('');
            let draftWarning = draftCount > 0 ? `<div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg text-center"><p class="font-semibold text-amber-800">Warning: ${draftCount} observation(s) are still in draft and not included in this report.</p></div>` : '';
            modalContainer.innerHTML = `<div id="reportModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50"><div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[98vh] flex flex-col"><header class="p-4 border-b flex justify-between items-center shrink-0"><h2 class="text-xl font-bold text-[#0D47A1]">Final Audit Report</h2><button onclick="closeAllModals()" class="text-slate-500 hover:text-red-500 text-3xl">&times;</button></header><div class="p-8 flex-grow overflow-y-auto"><div class="mb-6 pb-4 border-b"><h3 class="text-2xl font-black text-[#0D47A1]">Audit of PharmaCore Aseptic Filling, Site C</h3><p class="text-sm text-slate-500">Report ID: AUD-2025-045 | Date: ${new Date().toLocaleDateString()}</p></div><div class="mb-8"><h4 class="font-bold text-lg mb-2">Overall Grade</h4><p class="font-bold text-xl inline-block px-4 py-2 rounded-lg bg-${gradeColor}-100 text-${gradeColor}-800">${grade}</p></div><div class="mb-8"><h4 class="font-bold text-lg mb-2">Executive Summary</h4><p class="text-slate-700 whitespace-pre-wrap leading-relaxed">${summary}</p></div><div><h4 class="font-bold text-lg mb-4 pb-4 border-b">Finalized Findings (${finalizedFindings.length})</h4><div class="space-y-6">${findingsHtml}</div></div>${draftWarning}</div><footer class="p-4 bg-slate-50 border-t flex justify-end space-x-3 shrink-0"><button class="bg-slate-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-slate-600">Export PDF</button><button class="bg-[#00A6ED] text-white font-bold px-4 py-2 rounded-lg hover:bg-[#0D47A1]">Submit for Review</button></footer></div></div>`;
        }
        function openObservationDetails(id) {
            const item = auditData.find(d => d.id === id); if (!item) return;
            const modalContainer = document.getElementById('modalContainer');
            const statusClass = item.status === 'Draft' ? 'Draft' : item.severity;
            const statusTag = item.status === 'Draft' ? `<span class="text-sm font-semibold bg-slate-200 text-slate-600 px-3 py-1 rounded-full">Draft</span>` : `<span class="text-sm font-semibold bg-${statusClass==='Major'?'amber':statusClass==='Critical'?'red':'sky'}-100 text-${statusClass==='Major'?'amber':statusClass==='Critical'?'red':'sky'}-800 px-3 py-1 rounded-full">${item.severity}</span>`;
            const actions = item.status === 'Draft' ? `<button onclick="openFinalizeModal(${item.id})" class="bg-sky-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-sky-600">Finalize Observation</button>` : '';
            const regulationsHtml = item.regulations.map(r => `<div class="mt-2"><span class="bg-slate-200 text-slate-800 text-xs font-semibold px-2 py-1 rounded-full">${r.id}</span><p class="text-xs text-slate-500 mt-1 pl-1">${r.justification}</p></div>`).join('');
            modalContainer.innerHTML = `<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50"><div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[98vh] flex flex-col"><header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold text-[#0D47A1]">${item.title}</h2><button onclick="closeAllModals()" class="text-slate-500 hover:text-red-500 text-3xl">&times;</button></header><div class="p-8 flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-semibold mb-2">Evidence</h3><div class="grid grid-cols-2 gap-2">${item.evidence.map(e => `<img src="${e.src}" alt="${e.alt}" class="w-full h-40 object-cover rounded-lg bg-slate-200">`).join('')}</div></div><div class="space-y-4"><div><h3 class="font-semibold text-sm text-slate-500">Status</h3>${statusTag}</div><div><h3 class="font-semibold text-sm text-slate-500">Full Observation Text</h3><p class="text-slate-700 bg-slate-50 p-3 rounded-md">${item.text}</p></div><div><h3 class="font-semibold text-sm text-slate-500">Relevant Regulations & SOPs</h3><div class="space-y-2">${regulationsHtml}</div></div><div><h3 class="font-semibold text-sm text-slate-500">Recommended CAPA Plan</h3><p class="text-slate-700 bg-slate-50 p-3 rounded-md text-sm">${item.capaRecommendation || 'N/A'}</p></div><div><h3 class="font-semibold text-sm text-slate-500">Linked to Agenda</h3><p class="text-slate-700">${item.agendaId} - ${agendaMap[item.agendaId]}</p></div></div></div><footer class="p-4 bg-slate-50 border-t flex justify-end">${actions}</footer></div></div>`;
        }
        function closeAllModals() { document.getElementById('modalContainer').innerHTML = ''; }
        
// ============================================================================
// FINALIZATION & REPORT GENERATION - NEW SYSTEM
// ============================================================================

let selectedGrade = null;
let currentFinalizationFilter = 'all';

function renderFinalizationTab() {
    console.log('Rendering finalization tab...');
    console.log('Fieldwork observations available:', fieldworkObservations ? fieldworkObservations.length : 0);
    
    loadFinalizationObservations();
    updateFinalizationStats();
    updateFinalizationCounts();
    checkFinalReportReady();
}

function loadFinalizationObservations() {
    const container = document.getElementById('finalizationObsList');
    
    if (!container) {
        console.error('Finalization observations container not found');
        return;
    }
    
    // Initialize if not exists
    if (!fieldworkObservations) {
        fieldworkObservations = [];
    }
    
    console.log('Loading finalization observations:', fieldworkObservations.length);
    
    if (fieldworkObservations.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-slate-500">
                <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-sm font-semibold mb-2">No observations from fieldwork yet</p>
                <p class="text-xs text-slate-400">Complete observations in the Fieldwork tab first, then return here to finalize them.</p>
            </div>
        `;
        return;
    }
    
    // Add finalization status if not present
    fieldworkObservations.forEach(obs => {
        if (!obs.finalizationStatus) {
            obs.finalizationStatus = 'draft';
        }
    });
    
    renderFinalizationObservationsList();
}

function renderFinalizationObservationsList() {
    const container = document.getElementById('finalizationObsList');
    
    if (!container) {
        console.error('Finalization observations list container not found');
        return;
    }
    
    if (!fieldworkObservations) {
        console.warn('fieldworkObservations is undefined');
        fieldworkObservations = [];
    }
    
    console.log('Rendering observations list. Total observations:', fieldworkObservations.length);
    console.log('Current filter:', currentFinalizationFilter);
    
    // Filter observations
    let filtered = fieldworkObservations;
    if (currentFinalizationFilter === 'draft') {
        filtered = fieldworkObservations.filter(obs => obs.finalizationStatus === 'draft');
    } else if (currentFinalizationFilter === 'final') {
        filtered = fieldworkObservations.filter(obs => obs.finalizationStatus === 'final');
    }
    
    console.log('Filtered observations:', filtered.length);
    
    if (filtered.length === 0) {
        const message = fieldworkObservations.length === 0 
            ? 'No observations from fieldwork yet.' 
            : `No ${currentFinalizationFilter} observations.`;
        container.innerHTML = `
            <div class="text-center py-8 text-slate-400">
                <p class="text-sm">${message}</p>
                ${fieldworkObservations.length > 0 ? '<p class="text-xs mt-2">Try selecting "All" to see all observations.</p>' : ''}
            </div>
        `;
        return;
    }
    
    try {
        const cardsHtml = filtered.map(obs => createFinalizationObsCard(obs)).join('');
        console.log('Generated HTML for', filtered.length, 'cards');
        container.innerHTML = cardsHtml;
    } catch (error) {
        console.error('Error rendering observation cards:', error);
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <p class="text-sm font-semibold">Error rendering observations</p>
                <p class="text-xs mt-2">${error.message}</p>
            </div>
        `;
    }
}

function createFinalizationObsCard(obs) {
    try {
        if (!obs) {
            console.error('Observation is null or undefined');
            return '<div class="p-3 bg-red-50 text-red-700 text-sm">Error: Invalid observation</div>';
        }
        
        const statusColors = {
            'compliant': { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-800', badge: 'bg-green-500' },
            'gap': { bg: 'bg-amber-50', border: 'border-amber-300', text: 'text-amber-800', badge: 'bg-amber-500' },
            'non-compliant': { bg: 'bg-red-50', border: 'border-red-300', text: 'text-red-800', badge: 'bg-red-500' }
        };
        
        const complianceStatus = obs.complianceStatus || 'gap';
        const severity = obs.severity || 'minor';
        const colors = statusColors[complianceStatus] || statusColors['gap'];
        const isDraft = obs.finalizationStatus === 'draft';
        const requirements = obs.linkedRequirements || [];
        const observationText = obs.observationText || 'No observation text';
        const obsId = obs.id || 'unknown';
        
        return `
            <div class="border-2 ${colors.border} ${colors.bg} rounded-lg p-3">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-1 ${colors.badge} text-white rounded text-xs font-bold">
                                ${complianceStatus.toUpperCase()}
                            </span>
                            <span class="px-2 py-1 ${isDraft ? 'bg-amber-100 text-amber-800' : 'bg-green-100 text-green-800'} rounded text-xs font-bold">
                                ${isDraft ? '📝 DRAFT' : '✓ FINAL'}
                            </span>
                            <span class="text-xs text-slate-600">${severity.toUpperCase()}</span>
                        </div>
                        <div class="text-xs text-slate-600">
                            ${obs.metadata?.location ? `📍 ${obs.metadata.location}` : ''} 
                            ${obs.metadata?.interviewed ? `· 👥 ${obs.metadata.interviewed}` : ''}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="event.stopPropagation(); editObservationForReport('${obsId}')" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600" title="Edit">
                            ✏️
                        </button>
                        <button onclick="event.stopPropagation(); toggleObservationStatus('${obsId}')" class="px-2 py-1 ${isDraft ? 'bg-green-500' : 'bg-amber-500'} text-white rounded text-xs hover:opacity-80" title="${isDraft ? 'Mark as Final' : 'Mark as Draft'}">
                            ${isDraft ? '✓' : '📝'}
                        </button>
                    </div>
                </div>
                
                <div class="text-sm text-slate-700 mb-2 line-clamp-2">
                    ${observationText}
                </div>
                
                ${requirements.length > 0 ? `
                <div class="text-xs text-purple-700 mt-2">
                    🔗 ${requirements.length} requirement(s): ${requirements.map(r => r.id || 'N/A').join(', ')}
                </div>
                ` : ''}
                
                <button onclick="openObservationModal('${obsId}')" class="mt-2 text-xs text-blue-600 hover:text-blue-800 font-semibold">
                    View Full Details →
                </button>
            </div>
        `;
    } catch (error) {
        console.error('Error creating finalization card:', error, obs);
        return `<div class="p-3 bg-red-50 text-red-700 text-sm">Error rendering observation: ${error.message}</div>`;
    }
}

function toggleObservationStatus(obsId) {
    const obs = fieldworkObservations.find(o => o.id === obsId);
    if (!obs) return;
    
    obs.finalizationStatus = obs.finalizationStatus === 'draft' ? 'final' : 'draft';
    
    renderFinalizationObservationsList();
    updateFinalizationStats();
    updateFinalizationCounts();
    checkFinalReportReady();
}

function editObservationForReport(obsId) {
    const obs = fieldworkObservations.find(o => o.id === obsId);
    if (!obs) return;
    
    const newText = prompt('Edit observation text:', obs.observationText);
    if (newText && newText.trim()) {
        obs.observationText = newText.trim();
        renderFinalizationObservationsList();
        alert('✓ Observation updated');
    }
}

function filterFinalizationObs(filter) {
    currentFinalizationFilter = filter;
    
    // Update button styles
    document.querySelectorAll('.finalization-filter-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-slate-200', 'text-slate-700');
    });
    event.target.classList.remove('bg-slate-200', 'text-slate-700');
    event.target.classList.add('bg-blue-600', 'text-white');
    
    renderFinalizationObservationsList();
}

function updateFinalizationStats() {
    if (!fieldworkObservations) fieldworkObservations = [];
    
    const total = fieldworkObservations.length;
    const draft = fieldworkObservations.filter(o => o.finalizationStatus === 'draft').length;
    const final = fieldworkObservations.filter(o => o.finalizationStatus === 'final').length;
    const gaps = fieldworkObservations.filter(o => o.complianceStatus !== 'compliant').length;
    
    const totalEl = document.getElementById('finalTotalObs');
    const draftEl = document.getElementById('finalDraftCount');
    const finalEl = document.getElementById('finalFinalCount');
    const gapsEl = document.getElementById('finalGapsCount');
    
    if (totalEl) totalEl.textContent = total;
    if (draftEl) draftEl.textContent = draft;
    if (finalEl) finalEl.textContent = final;
    if (gapsEl) gapsEl.textContent = gaps;
}

function updateFinalizationCounts() {
    if (!fieldworkObservations) fieldworkObservations = [];
    
    const total = fieldworkObservations.length;
    const draft = fieldworkObservations.filter(o => o.finalizationStatus === 'draft').length;
    const final = fieldworkObservations.filter(o => o.finalizationStatus === 'final').length;
    
    const allEl = document.getElementById('filterAllCount');
    const draftEl = document.getElementById('filterDraftCount');
    const finalEl = document.getElementById('filterFinalCount');
    
    if (allEl) allEl.textContent = total;
    if (draftEl) draftEl.textContent = draft;
    if (finalEl) finalEl.textContent = final;
}

function selectGrade(grade) {
    selectedGrade = grade;
    
    // Update button styles
    document.querySelectorAll('.grade-btn').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-100', 'border-amber-500', 'bg-amber-100', 'border-red-500', 'bg-red-100');
        btn.classList.add('border-slate-300', 'bg-slate-100');
    });
    
    const btn = document.getElementById(`grade-${grade}`);
    btn.classList.remove('border-slate-300', 'bg-slate-100');
    
    if (grade === 'acceptable') {
        btn.classList.add('border-green-500', 'bg-green-100');
    } else if (grade === 'conditional') {
        btn.classList.add('border-amber-500', 'bg-amber-100');
    } else {
        btn.classList.add('border-red-500', 'bg-red-100');
    }
    
    checkFinalReportReady();
}

function checkFinalReportReady() {
    if (!fieldworkObservations) fieldworkObservations = [];
    
    const btn = document.getElementById('generateFinalBtn');
    const helper = document.getElementById('reportHelper');
    
    if (!btn || !helper) return;
    
    if (fieldworkObservations.length === 0) {
        btn.disabled = true;
        helper.textContent = 'No observations to include in report';
        helper.classList.remove('text-green-600');
        helper.classList.add('text-slate-600');
        return;
    }
    
    const allFinalized = fieldworkObservations.every(o => o.finalizationStatus === 'final');
    const hasGrade = selectedGrade !== null;
    
    if (allFinalized && hasGrade && fieldworkObservations.length > 0) {
        btn.disabled = false;
        helper.textContent = 'Ready to generate final report';
        helper.classList.remove('text-slate-600');
        helper.classList.add('text-green-600');
    } else {
        btn.disabled = true;
        const draftCount = fieldworkObservations.filter(o => o.finalizationStatus === 'draft').length;
        if (draftCount > 0) {
            helper.textContent = `${draftCount} observation(s) still in draft status`;
        } else if (!hasGrade) {
            helper.textContent = 'Select an overall assessment grade';
        }
        helper.classList.remove('text-green-600');
        helper.classList.add('text-slate-600');
    }
}

function generateDraftReport() {
    const finalObs = fieldworkObservations.filter(o => o.finalizationStatus === 'final');
    
    if (finalObs.length === 0) {
        alert('Please finalize at least one observation first.');
        return;
    }
    
    // Auto-generate executive summary
    const gapsCount = finalObs.filter(o => o.complianceStatus !== 'compliant').length;
    const criticalCount = finalObs.filter(o => o.severity === 'critical').length;
    const majorCount = finalObs.filter(o => o.severity === 'major').length;
    const minorCount = finalObs.filter(o => o.severity === 'minor').length;
    
    const summary = `This audit report summarizes the findings from the fieldwork conducted at the facility.\n\nA total of ${finalObs.length} observations were documented during the audit process. Of these, ${gapsCount} observations identified compliance gaps or non-conformances that require attention.\n\nSeverity breakdown:\n- Critical: ${criticalCount}\n- Major: ${majorCount}\n- Minor: ${minorCount}\n\nThese findings are based on document review, facility walkthrough, personnel interviews, and direct observation of processes and procedures.`;
    
    document.getElementById('executiveSummary').value = summary;
    
    // Auto-generate key findings
    const topFindings = finalObs
        .filter(o => o.complianceStatus !== 'compliant')
        .slice(0, 3)
        .map(o => `• ${o.observationText.substring(0, 100)}...`)
        .join('\n');
    
    document.getElementById('keyFindings').value = topFindings || 'No significant gaps identified.';
    
    // Auto-generate recommendations
    const recommendations = finalObs
        .filter(o => o.aiAnalysis?.recommendations)
        .slice(0, 3)
        .map(o => `• ${o.aiAnalysis.recommendations.substring(0, 100)}...`)
        .join('\n');
    
    document.getElementById('recommendations').value = recommendations || 'Maintain current compliance practices.';
    
    alert('✓ Draft report generated! Review and edit as needed.');
}

function generateFinalReport() {
    const executive = document.getElementById('executiveSummary').value.trim();
    const keyFindings = document.getElementById('keyFindings').value.trim();
    const recommendations = document.getElementById('recommendations').value.trim();
    
    if (!executive || !keyFindings || !selectedGrade) {
        alert('Please complete all sections before generating the final report.');
        return;
    }
    
    // Open report in modal or new window
    const finalObs = fieldworkObservations.filter(o => o.finalizationStatus === 'final');
    const reportHtml = generateReportHTML(finalObs, executive, keyFindings, recommendations);
    
    // Open in new window
    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(reportHtml);
    reportWindow.document.close();
    
    alert('✓ Final report generated and opened in new window!');
}

function generateReportHTML(observations, executive, keyFindings, recommendations) {
    const gradeText = selectedGrade === 'acceptable' ? 'Acceptable' : 
                    selectedGrade === 'conditional' ? 'Acceptable with Conditions' : 'Unacceptable';
    const gradeColor = selectedGrade === 'acceptable' ? '#10b981' : 
                     selectedGrade === 'conditional' ? '#f59e0b' : '#ef4444';
    
    const obsHtml = observations.map(obs => {
        const requirements = obs.linkedRequirements || [];
        const reqText = requirements.map(r => {
            const citation = r.citation || extractCitation(r['requirement_text (verbatim)'] || '');
            return `${r.id}: ${citation}`;
        }).join(', ');
        
        return `
            <div style="margin-bottom: 20px; padding: 15px; border-left: 4px solid ${obs.complianceStatus === 'compliant' ? '#10b981' : obs.complianceStatus === 'gap' ? '#f59e0b' : '#ef4444'}; background: #f9fafb;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <span style="padding: 4px 8px; background: ${obs.complianceStatus === 'compliant' ? '#10b981' : obs.complianceStatus === 'gap' ? '#f59e0b' : '#ef4444'}; color: white; font-size: 12px; border-radius: 4px; font-weight: bold;">${obs.complianceStatus.toUpperCase()}</span>
                    <span style="padding: 4px 8px; background: #64748b; color: white; font-size: 12px; border-radius: 4px; font-weight: bold;">${obs.severity.toUpperCase()}</span>
                </div>
                <p style="margin: 10px 0; line-height: 1.6;">${obs.observationText}</p>
                ${obs.metadata?.location ? `<p style="font-size: 14px; color: #64748b; margin: 5px 0;">📍 Location: ${obs.metadata.location}</p>` : ''}
                ${reqText ? `<p style="font-size: 14px; color: #7c3aed; margin: 5px 0;">🔗 Requirements: ${reqText}</p>` : ''}
                ${obs.evidence && obs.evidence.length > 0 ? `<p style="font-size: 14px; color: #64748b; margin: 5px 0;">📎 Evidence: ${obs.evidence.length} item(s)</p>` : ''}
            </div>
        `;
    }).join('');
    
    return `
<!DOCTYPE html>
<html>
<head>
    <title>Audit Report - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; color: #333; }
        h1 { color: #0D47A1; border-bottom: 3px solid #0D47A1; padding-bottom: 10px; }
        h2 { color: #0D47A1; margin-top: 30px; }
        .grade { padding: 15px; background: ${gradeColor}; color: white; text-align: center; font-size: 24px; font-weight: bold; border-radius: 8px; margin: 20px 0; }
        .section { margin: 20px 0; }
        @media print { body { margin: 20px; } }
    </style>
</head>
<body>
    <h1>🏭 GMP Audit Report</h1>
    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
    <p><strong>Total Observations:</strong> ${observations.length}</p>
    <p><strong>Gaps Identified:</strong> ${observations.filter(o => o.complianceStatus !== 'compliant').length}</p>
    
    <div class="grade">Overall Assessment: ${gradeText}</div>
    
    <h2>Executive Summary</h2>
    <div class="section">${executive.replace(/\n/g, '<br>')}</div>
    
    <h2>Key Findings</h2>
    <div class="section">${keyFindings.replace(/\n/g, '<br>')}</div>
    
    <h2>Recommendations</h2>
    <div class="section">${recommendations.replace(/\n/g, '<br>')}</div>
    
    <h2>Detailed Observations</h2>
    <div class="section">${obsHtml}</div>
    
    <hr style="margin: 40px 0;">
    <p style="text-align: center; color: #64748b; font-size: 12px;">End of Report</p>
</body>
</html>
    `;
}

        // INITIAL LOAD
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('prep');
            renderDocumentGallery();
            renderFocusAreas();
        });
        
// ============================================================================
// FIELDWORK OBSERVATIONS - AI-ENHANCED
// ============================================================================

let currentRequirements = [];  // Changed to array for multi-select
let fieldworkRequirements = [];
let fieldworkObservations = [];
let capturedImages = [];  // Changed to array for multiple images (max 5)
let capturedDocuments = [];  // Array for PDF documents
let capturedHandwrittenNotes = null;  // Handwritten notes image and transcription
let capturedAudio = null;
let capturedAudioBlob = null;
let aiAnalysisResult = null;
let mediaRecorder = null;
let audioChunks = [];
let recordingStartTime = null;
let recordingInterval = null;
const MAX_IMAGES = 5;
const MAX_DOCUMENTS = 10;

// Load requirements into fieldwork
async function loadFieldworkRequirements() {
    if (!generatedRequirements || !generatedRequirements.categories) {
        document.getElementById('fieldworkReqList').innerHTML = `
            <div class="text-center py-8 text-slate-500">
                <p class="mb-2">No requirements loaded</p>
                <p class="text-sm">Go to "Pre-Audit Prep" and generate requirements first</p>
            </div>
        `;
        return;
    }
    
    fieldworkRequirements = [];
    generatedRequirements.categories.forEach(cat => {
        cat.requirements.forEach(req => {
            // Extract and add citation when loading requirements
            const requirementText = req['requirement_text (verbatim)'] || req.requirement_text || '';
            if (!req.citation) {
                req.citation = extractCitation(requirementText);
            }
            fieldworkRequirements.push(req);
        });
    });
    
    displayFieldworkRequirements();
    await loadFieldworkObservations();
    updateFieldworkStats();
}

function displayFieldworkRequirements() {
    const container = document.getElementById('fieldworkReqList');
    
    if (fieldworkRequirements.length === 0) {
        container.innerHTML = '<p class="text-center text-slate-500 py-4">No requirements found</p>';
        return;
    }
    
    container.innerHTML = '';
    
    fieldworkRequirements.forEach(req => {
        const obsCount = fieldworkObservations.filter(obs => 
            obs.linkedRequirement && obs.linkedRequirement.id === req.id
        ).length;
        
        const card = document.createElement('div');
        card.className = 'border border-slate-200 rounded-lg p-3 bg-white hover:border-purple-300 transition-colors';
        
        const riskColors = {
            'Critical': 'bg-red-100 text-red-800 border-red-300',
            'High': 'bg-orange-100 text-orange-800 border-orange-300',
            'Medium': 'bg-yellow-100 text-yellow-800 border-yellow-300',
            'Low': 'bg-blue-100 text-blue-800 border-blue-300'
        };
        
        const requirementText = req['requirement_text (verbatim)'] || req.requirement_text || '';
        const citation = extractCitation(requirementText);
        const cleanText = cleanRequirementText(requirementText);
        
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-mono font-bold text-purple-700">${req.id}</span>
                        <span class="px-2 py-0.5 text-xs rounded-full border ${riskColors[req.risk_level] || riskColors.Medium}">
                            ${req.risk_level}
                        </span>
                    </div>
                    <div class="text-xs text-blue-600 font-semibold">${citation || req.regulation_name || 'N/A'}</div>
                </div>
                ${obsCount > 0 ? `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-semibold">${obsCount} ✓</span>` : ''}
            </div>
            <p class="text-xs text-slate-600 line-clamp-3 leading-relaxed">${cleanText}</p>
        `;
        
        container.appendChild(card);
    });
    
    // Also populate the requirement checkboxes
    populateRequirementCheckboxes();
}

function populateRequirementCheckboxes() {
    const container = document.getElementById('requirementCheckboxes');
    if (!container) return;
    
    container.innerHTML = '';
    
    fieldworkRequirements.forEach(req => {
        const requirementText = req['requirement_text (verbatim)'] || req.requirement_text || '';
        const citation = extractCitation(requirementText);
        const cleanText = cleanRequirementText(requirementText);
        
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'flex items-start p-2 hover:bg-slate-50 rounded border border-slate-200';
        checkboxDiv.innerHTML = `
            <input type="checkbox" id="req-checkbox-${req.id}" value="${req.id}" 
                   onchange="updateSelectedRequirements()" 
                   class="mt-1 mr-2 w-4 h-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500">
            <label for="req-checkbox-${req.id}" class="flex-1 cursor-pointer">
                <div class="text-xs font-mono font-bold text-purple-700">${req.id}</div>
                <div class="text-xs text-blue-600 font-semibold">${citation || req.regulation_name || 'N/A'}</div>
                <div class="text-xs text-slate-600 line-clamp-2">${cleanText.substring(0, 100)}${cleanText.length > 100 ? '...' : ''}</div>
            </label>
        `;
        container.appendChild(checkboxDiv);
    });
    
    updateSelectedCount();
}

function openObservationForm(event, requirement) {
    if (event) event.stopPropagation();
    currentRequirements = requirement ? [requirement] : [];  // Store as array
    
    // Clear form
    resetObservationForm();
    
    // Pre-check the requirement if provided
    if (requirement) {
        const checkbox = document.getElementById(`req-checkbox-${requirement.id}`);
        if (checkbox) {
            checkbox.checked = true;
            updateSelectedRequirements();
        }
    }
}

function viewRequirementDetail(requirement) {
    // This function is deprecated in the new UI
    // Observations are now saved directly without switching views
    console.log('Viewing details for requirement:', requirement.id);
}

function createObservationCard(obs) {
    const statusColors = {
        'compliant': 'bg-green-50 border-green-200',
        'gap': 'bg-amber-50 border-amber-200',
        'non-compliant': 'bg-red-50 border-red-200'
    };
    
    const statusLabels = {
        'compliant': '✓ Compliant',
        'gap': '⚠️ Gap',
        'non-compliant': '✗ Non-Compliant'
    };
    
    return `
        <div class="border-2 ${statusColors[obs.complianceStatus]} rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <span class="text-sm font-semibold">${obs.id}</span>
                    <span class="ml-2 text-sm">${statusLabels[obs.complianceStatus]}</span>
                    ${obs.severity !== 'minor' ? `<span class="ml-2 text-xs text-slate-600">(${obs.severity})</span>` : ''}
                </div>
                <span class="text-xs text-slate-500">${new Date(obs.metadata.timestamp).toLocaleString()}</span>
            </div>
            <p class="text-sm text-slate-700 mb-2">${obs.observationText}</p>
            ${obs.metadata.location ? `<p class="text-xs text-slate-600">📍 ${obs.metadata.location}</p>` : ''}
            ${obs.metadata.interviewed ? `<p class="text-xs text-slate-600">👤 ${obs.metadata.interviewed}</p>` : ''}
        </div>
    `;
}

function closeObservationDetail() {
    // This function is deprecated in the new UI
    console.log('Close observation detail called');
}

// Multi-image handling
function handleMultipleImageCapture(event) {
    const files = Array.from(event.target.files);
    if (!files.length) return;
    
    // Calculate how many more images we can add
    const remainingSlots = MAX_IMAGES - capturedImages.length;
    const filesToAdd = files.slice(0, remainingSlots);
    
    if (files.length > remainingSlots) {
        alert(`Maximum ${MAX_IMAGES} photos allowed. Adding only the first ${remainingSlots}.`);
    }
    
    // Read each file and add to capturedImages
    filesToAdd.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = e.target.result;
            const imageId = `img-${Date.now()}-${index}`;
            
            capturedImages.push({
                id: imageId,
                data: imageData,
                name: file.name
            });
            
            updateImageGallery();
        };
        reader.readAsDataURL(file);
    });
    
    // Reset file input
    event.target.value = '';
}

function updateImageGallery() {
    const gallery = document.getElementById('imageGallery');
    const grid = document.getElementById('imageGalleryGrid');
    const photoCount = document.getElementById('photoCount');
    const addPhotoBtn = document.getElementById('addPhotoBtn');
    
    // Update counter
    photoCount.textContent = capturedImages.length;
    
    // Show/hide gallery
    if (capturedImages.length > 0) {
        gallery.classList.remove('hidden');
    } else {
        gallery.classList.add('hidden');
    }
    
    // Disable button if at max
    if (capturedImages.length >= MAX_IMAGES) {
        addPhotoBtn.disabled = true;
        addPhotoBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        addPhotoBtn.disabled = false;
        addPhotoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    // Render image thumbnails
    grid.innerHTML = capturedImages.map((img, index) => `
        <div class="relative group">
            <img src="${img.data}" class="w-full h-24 object-cover rounded border-2 border-blue-300">
            <button onclick="removeImage('${img.id}')" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity">×</button>
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs text-center py-0.5">
                Photo ${index + 1}
            </div>
        </div>
    `).join('');
}

function removeImage(imageId) {
    capturedImages = capturedImages.filter(img => img.id !== imageId);
    updateImageGallery();
}

function clearAllImages() {
    capturedImages = [];
    document.getElementById('obsImageInput').value = '';
    document.getElementById('imageDescription').value = '';
    updateImageGallery();
}

// Document handling
function handleDocumentUpload(event) {
    const files = Array.from(event.target.files);
    
    // Check total documents limit
    if (capturedDocuments.length + files.length > MAX_DOCUMENTS) {
        alert(`You can only upload up to ${MAX_DOCUMENTS} documents`);
        return;
    }
    
    files.forEach(file => {
        if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
            const doc = {
                id: `doc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                name: file.name,
                size: file.size,
                type: 'application/pdf',
                file: file,
                timestamp: new Date().toISOString()
            };
            capturedDocuments.push(doc);
        } else {
            alert(`${file.name} is not a PDF file`);
        }
    });
    
    updateDocumentList();
}

function updateDocumentList() {
    const listContainer = document.getElementById('documentList');
    const listItems = document.getElementById('documentListItems');
    const countElement = document.getElementById('docCount');
    
    countElement.textContent = capturedDocuments.length;
    
    if (capturedDocuments.length === 0) {
        listContainer.classList.add('hidden');
        return;
    }
    
    listContainer.classList.remove('hidden');
    
    // Render document list
    listItems.innerHTML = capturedDocuments.map((doc, index) => `
        <div class="flex items-center justify-between p-2 bg-white rounded border border-green-300 text-xs">
            <div class="flex items-center gap-2 flex-1 min-w-0">
                <span class="text-green-600">📄</span>
                <span class="truncate font-medium text-slate-700">${doc.name}</span>
                <span class="text-slate-500 text-xs">(${(doc.size / 1024).toFixed(1)} KB)</span>
            </div>
            <button onclick="removeDocument('${doc.id}')" class="text-red-500 hover:text-red-700 ml-2 font-bold">×</button>
        </div>
    `).join('');
}

function removeDocument(docId) {
    capturedDocuments = capturedDocuments.filter(doc => doc.id !== docId);
    updateDocumentList();
}

function clearAllDocuments() {
    capturedDocuments = [];
    document.getElementById('obsDocumentInput').value = '';
    updateDocumentList();
}

// Handwritten notes handling
function handleHandwrittenNotesUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate image file
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        capturedHandwrittenNotes = {
            imageData: e.target.result,
            transcription: '',
            timestamp: new Date().toISOString()
        };
        
        // Display preview
        document.getElementById('notesImage').src = e.target.result;
        document.getElementById('notesPreview').classList.remove('hidden');
        document.getElementById('notesTranscriptionArea').classList.add('hidden');
        document.getElementById('notesTranscription').value = '';
    };
    reader.readAsDataURL(file);
}

async function transcribeHandwrittenNotes() {
    if (!capturedHandwrittenNotes) return;
    
    const btn = document.getElementById('transcribeNotesBtn');
    const transcriptionArea = document.getElementById('notesTranscriptionArea');
    const transcriptionText = document.getElementById('notesTranscription');
    
    // Show loading state
    btn.disabled = true;
    btn.textContent = '🤖 Transcribing...';
    
    try {
        const response = await fetch('/api/handwritten/transcribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: capturedHandwrittenNotes.imageData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            capturedHandwrittenNotes.transcription = result.transcription;
            transcriptionText.value = result.transcription;
            transcriptionArea.classList.remove('hidden');
            btn.textContent = '✓ Transcribed';
            btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
        } else {
            alert('Transcription failed: ' + result.error);
            btn.disabled = false;
            btn.textContent = '🤖 Transcribe with AI';
        }
    } catch (error) {
        console.error('Transcription error:', error);
        alert('Transcription failed: ' + error.message);
        btn.disabled = false;
        btn.textContent = '🤖 Transcribe with AI';
    }
}

function clearHandwrittenNotes() {
    capturedHandwrittenNotes = null;
    document.getElementById('obsNotesInput').value = '';
    document.getElementById('notesPreview').classList.add('hidden');
    document.getElementById('notesTranscriptionArea').classList.add('hidden');
    document.getElementById('notesTranscription').value = '';
    
    // Reset button
    const btn = document.getElementById('transcribeNotesBtn');
    btn.disabled = false;
    btn.textContent = '🤖 Transcribe with AI';
    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
    btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
}

// Audio recording
async function toggleRecording() {
    const btn = document.getElementById('recordBtn');
    const btnText = document.getElementById('recordBtnText');
    
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                capturedAudio = URL.createObjectURL(audioBlob);
                capturedAudioBlob = audioBlob;
                
                document.getElementById('audioPreview').classList.remove('hidden');
                document.getElementById('audioTranscription').classList.remove('hidden');
                document.getElementById('audioTranscription').value = "🔄 Transcribing audio...";
                
                stream.getTracks().forEach(track => track.stop());
                clearInterval(recordingInterval);
                
                // Automatically transcribe the audio
                await transcribeAudio(audioBlob);
            };
            
            mediaRecorder.start();
            recordingStartTime = Date.now();
            btn.classList.add('recording');
            btnText.innerText = 'Stop Recording';
            
            recordingInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('recordDuration').innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
        } catch (error) {
            console.error('Microphone error:', error);
            alert('Could not access microphone. Please grant permission.');
        }
    } else {
        mediaRecorder.stop();
        btn.classList.remove('recording');
        btnText.innerText = 'Start Recording';
    }
}

function clearAudio() {
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    capturedAudio = null;
    capturedAudioBlob = null;
    audioChunks = [];
    document.getElementById('audioPreview').classList.add('hidden');
    document.getElementById('audioTranscription').classList.add('hidden');
    document.getElementById('audioTranscription').value = '';
    document.getElementById('recordBtn').classList.remove('recording');
    document.getElementById('recordBtnText').innerText = 'Start Recording';
}

async function transcribeAudio(audioBlob) {
    const transcriptionField = document.getElementById('audioTranscription');
    
    try {
        // Create FormData to send audio file
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        // Call backend transcription endpoint
        const response = await fetch('/api/audio/transcribe', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            transcriptionField.value = result.transcription;
            console.log('✓ Audio transcribed successfully');
        } else {
            transcriptionField.value = `❌ Transcription failed: ${result.error}`;
            console.error('Transcription error:', result.error);
        }
    } catch (error) {
        transcriptionField.value = `❌ Transcription error: ${error.message}`;
        console.error('Error transcribing audio:', error);
    }
}

// AI Analysis
async function analyzeWithAI() {
    const obsText = document.getElementById('obsText').value.trim();
    const imageDesc = document.getElementById('imageDescription').value.trim();
    const audioTrans = document.getElementById('audioTranscription').value.trim();
    
    if (!obsText && !imageDesc && !audioTrans && capturedImages.length === 0) {
        alert('Please enter at least one form of observation');
        return;
    }
    
    const analyzeBtn = document.getElementById('analyzeBtn');
    const originalText = analyzeBtn.innerHTML;
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = `<svg class="animate-spin w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing${capturedImages.length > 1 ? ` ${capturedImages.length} photos` : ''}...`;
    
    try {
        const response = await fetch('/api/observations/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                observationText: obsText,
                imageDescription: imageDesc,
                imageData: capturedImages.map(img => img.data), // Send array of Base64 images
                audioTranscription: audioTrans,
                requirements: fieldworkRequirements
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            aiAnalysisResult = result.analysis;
            displayRequirementMatch(result.analysis);
        } else {
            alert('AI analysis failed: ' + result.error);
        }
    } catch (error) {
        alert('Failed to analyze: ' + error.message);
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = originalText;
    }
}

function displayRequirementMatch(analysis) {
    // Show Step 2: Requirement Match
    document.getElementById('requirementMatchSection').classList.remove('hidden');
    document.getElementById('additionalDetailsSection').classList.remove('hidden');
    
    // Display AI-suggested observation text if available
    if (analysis.suggested_observation_text) {
        document.getElementById('aiSuggestedObsText').textContent = analysis.suggested_observation_text;
        document.getElementById('aiObservationTextSection').classList.remove('hidden');
    }
    
    // Display AI's matched requirements (multiple)
    if (analysis.matched_requirements && analysis.matched_requirements.length > 0) {
        const aiMatchedReqs = document.getElementById('aiMatchedReqs');
        aiMatchedReqs.innerHTML = '';
        
        analysis.matched_requirements.forEach((match, index) => {
            const req = fieldworkRequirements.find(r => r.id === match.requirement_id);
            
            if (req) {
                const confidence = Math.round(match.confidence * 100);
                const requirementText = req['requirement_text (verbatim)'] || req.requirement_text || '';
                const citation = extractCitation(requirementText);
                const cleanText = cleanRequirementText(requirementText);
                
                const reqCard = document.createElement('div');
                reqCard.className = 'p-3 bg-white rounded-lg border-2 border-green-400';
                reqCard.innerHTML = `
                    <div class="flex items-start justify-between mb-1">
                        <div class="text-xs font-mono font-bold text-purple-700">${req.id}</div>
                        <div class="text-xs font-semibold text-green-600">${confidence}% confidence</div>
                    </div>
                    <div class="text-xs text-blue-600 font-semibold mb-1">${citation || req.regulation_name || 'N/A'}</div>
                    <div class="text-xs text-slate-600 mb-2">${cleanText.substring(0, 120)}${cleanText.length > 120 ? '...' : ''}</div>
                    <div class="text-xs text-green-700 italic">"${match.reasoning}"</div>
                `;
                aiMatchedReqs.appendChild(reqCard);
                
                // Auto-check this checkbox
                const checkbox = document.getElementById(`req-checkbox-${req.id}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            }
        });
        
        // Update current requirements with AI suggestions
        updateSelectedRequirements();
    }
    
    // Display key findings
    if (analysis.key_findings && analysis.key_findings.length > 0) {
        let findingsHTML = '<ul class="list-disc list-inside space-y-1">';
        analysis.key_findings.forEach(finding => {
            findingsHTML += `<li>${finding}</li>`;
        });
        findingsHTML += '</ul>';
        document.getElementById('aiKeyFindings').innerHTML = findingsHTML;
    }
    
    // Auto-fill compliance status and severity if suggested
    if (analysis.compliance_status) {
        const statusValue = analysis.compliance_status === 'non_compliant' ? 'non-compliant' : analysis.compliance_status;
        const statusRadio = document.querySelector(`input[name="obsStatus"][value="${statusValue}"]`);
        if (statusRadio) {
            statusRadio.checked = true;
            document.getElementById('aiSuggestedStatus').textContent = '(AI suggested)';
        }
    }
    
    if (analysis.severity) {
        document.getElementById('obsSeverity').value = analysis.severity;
        document.getElementById('aiSuggestedSeverity').textContent = '(AI suggested)';
    }
    
    // Enable save button
    document.getElementById('saveObsBtn').disabled = false;
}

function acceptAISuggestedText() {
    // Copy AI suggested text to observation textarea
    const suggestedText = document.getElementById('aiSuggestedObsText').textContent;
    document.getElementById('obsText').value = suggestedText;
    
    // Hide the suggestion box
    document.getElementById('aiObservationTextSection').classList.add('hidden');
}

// Multi-select requirement functions
function updateSelectedRequirements() {
    // Get all checked checkboxes
    const checkboxes = document.querySelectorAll('#requirementCheckboxes input[type="checkbox"]:checked');
    currentRequirements = Array.from(checkboxes).map(cb => {
        const req = fieldworkRequirements.find(req => req.id === cb.value);
        if (req) {
            // Extract and add citation if not already present
            const requirementText = req['requirement_text (verbatim)'] || req.requirement_text || '';
            if (!req.citation) {
                req.citation = extractCitation(requirementText);
            }
        }
        return req;
    }).filter(req => req !== undefined);
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = document.querySelectorAll('#requirementCheckboxes input[type="checkbox"]:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

function selectAllAIRecommendations() {
    // Check all checkboxes that correspond to AI recommendations
    if (!aiAnalysisResult || !aiAnalysisResult.matched_requirements) return;
    
    aiAnalysisResult.matched_requirements.forEach(match => {
        const checkbox = document.getElementById(`req-checkbox-${match.requirement_id}`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    updateSelectedRequirements();
}

function resetObservationForm() {
    // Clear all inputs
    document.getElementById('obsText').value = '';
    document.getElementById('obsLocation').value = '';
    document.getElementById('obsInterviewed').value = '';
    clearAllImages();
    clearAllDocuments();
    clearHandwrittenNotes();
    clearAudio();
    
    // Hide Step 2, 2b, and Step 3
    document.getElementById('requirementMatchSection').classList.add('hidden');
    document.getElementById('aiObservationTextSection').classList.add('hidden');
    document.getElementById('additionalDetailsSection').classList.add('hidden');
    
    // Uncheck all requirement checkboxes
    document.querySelectorAll('#requirementCheckboxes input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset form states
    document.querySelector('input[name="obsStatus"][value="gap"]').checked = true;
    document.getElementById('obsSeverity').value = 'major';
    document.getElementById('aiSuggestedStatus').textContent = '';
    document.getElementById('aiSuggestedSeverity').textContent = '';
    
    // Disable save button
    document.getElementById('saveObsBtn').disabled = true;
    
    // Reset current requirements array
    currentRequirements = [];
    aiAnalysisResult = null;
    updateSelectedCount();
}

function displayAISuggestions(analysis) {
    document.getElementById('aiSuggestionsPanel').classList.remove('hidden');
    
    let content = '';
    
    if (analysis.matched_requirements && analysis.matched_requirements.length > 0) {
        content += '<div class="mb-3"><h5 class="text-xs font-semibold text-green-800 mb-2">🎯 Matched Requirements:</h5>';
        analysis.matched_requirements.forEach(match => {
            const req = fieldworkRequirements.find(r => r.id === match.requirement_id);
            if (req) {
                const confidence = Math.round(match.confidence * 100);
                content += `
                    <div class="p-2 bg-white rounded border border-green-200 mb-2">
                        <div><span class="text-xs font-semibold text-green-700">${req.id}</span>
                        <span class="ml-2 text-xs text-green-600">${confidence}% match</span></div>
                        <p class="text-xs text-slate-600 mt-1">${match.reasoning}</p>
                    </div>
                `;
                if (analysis.matched_requirements[0].requirement_id === match.requirement_id) {
                    // Extract and add citation if not already present
                    const requirementText = req['requirement_text (verbatim)'] || req.requirement_text || '';
                    if (!req.citation) {
                        req.citation = extractCitation(requirementText);
                    }
                    currentRequirements = [req];  // Store as array
                }
            }
        });
        content += '</div>';
    }
    
    if (analysis.key_findings && analysis.key_findings.length > 0) {
        content += '<div class="mb-2"><h5 class="text-xs font-semibold text-blue-800 mb-1">🔍 Key Findings:</h5>';
        content += '<ul class="list-disc list-inside text-xs text-blue-700 space-y-0.5">';
        analysis.key_findings.forEach(finding => content += `<li>${finding}</li>`);
        content += '</ul></div>';
    }
    
    document.getElementById('aiSuggestionsContent').innerHTML = content;
    
    if (analysis.compliance_status) {
        const statusLabels = {
            'compliant': '(AI: Compliant)',
            'gap': '(AI: Gap)',
            'non_compliant': '(AI: Non-Compliant)'
        };
        document.getElementById('aiSuggestedStatus').innerText = statusLabels[analysis.compliance_status] || '';
    }
    
    if (analysis.severity) {
        document.getElementById('aiSuggestedSeverity').innerText = `(AI: ${analysis.severity})`;
    }
    
    if (analysis.analysis) {
        document.getElementById('aiAnalysisSection').classList.remove('hidden');
        document.getElementById('aiAnalysisText').innerText = analysis.analysis;
    }
    
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        document.getElementById('aiRecommendationsSection').classList.remove('hidden');
        let recsHTML = '';
        analysis.recommendations.forEach(rec => recsHTML += `<li>${rec}</li>`);
        document.getElementById('aiRecommendationsList').innerHTML = recsHTML;
    }
}

function acceptAISuggestions() {
    if (!aiAnalysisResult) return;
    
    if (aiAnalysisResult.compliance_status) {
        const statusValue = aiAnalysisResult.compliance_status === 'non_compliant' ? 'non-compliant' : aiAnalysisResult.compliance_status;
        document.querySelector(`input[name="obsStatus"][value="${statusValue}"]`).checked = true;
    }
    
    if (aiAnalysisResult.severity) {
        document.getElementById('obsSeverity').value = aiAnalysisResult.severity;
    }
    
    alert('✓ AI suggestions accepted!');
}

function resetAIAnalysis() {
    // Reset AI-related UI elements only if they exist
    const aiSuggestedStatus = document.getElementById('aiSuggestedStatus');
    const aiSuggestedSeverity = document.getElementById('aiSuggestedSeverity');
    
    if (aiSuggestedStatus) aiSuggestedStatus.textContent = '';
    if (aiSuggestedSeverity) aiSuggestedSeverity.textContent = '';
    
    aiAnalysisResult = null;
}

async function saveObservation() {
    const obsText = document.getElementById('obsText').value.trim();
    const location = document.getElementById('obsLocation').value.trim();
    const interviewed = document.getElementById('obsInterviewed').value.trim();
    const status = document.querySelector('input[name="obsStatus"]:checked').value;
    const severity = document.getElementById('obsSeverity').value;
    
    if (obsText.length < 50) {
        alert('Observation text must be at least 50 characters');
        return;
    }
    
    if (currentRequirements.length === 0) {
        alert('No requirements selected. Please select at least one requirement.');
        return;
    }
    
    // Collect evidence
    const evidence = [];
    
    // Add photos as evidence
    if (capturedImages.length > 0) {
        capturedImages.forEach((img, index) => {
            evidence.push({
                type: 'photo',
                url: img.data,  // Base64 data URL
                name: `Photo ${index + 1}`,
                timestamp: new Date().toISOString()
            });
        });
    }
    
    // Add audio with transcription
    const audioTranscription = document.getElementById('audioTranscription').value.trim();
    if (capturedAudioBlob && audioTranscription) {
        evidence.push({
            type: 'audio',
            url: capturedAudio,  // Blob URL for playback
            transcription: audioTranscription,
            duration: document.getElementById('recordDuration').innerText,
            timestamp: new Date().toISOString()
        });
    }
    
    // Add documents
    if (capturedDocuments.length > 0) {
        capturedDocuments.forEach(doc => {
            evidence.push({
                type: 'document',
                name: doc.name,
                size: doc.size,
                fileType: 'application/pdf',
                timestamp: doc.timestamp
            });
        });
    }
    
    // Get image description
    const imageDescription = document.getElementById('imageDescription').value.trim();
    
    // Get handwritten notes transcription
    const handwrittenTranscription = capturedHandwrittenNotes?.transcription || '';
    
    const observationData = {
        linkedRequirements: currentRequirements,  // Now an array
        observationText: obsText,
        complianceStatus: status,
        severity: status === 'compliant' ? 'minor' : severity,
        category: currentRequirements[0].category,  // Use first requirement's category
        location: location,
        interviewed: interviewed,
        imageDescription: imageDescription,
        audioTranscription: audioTranscription,
        handwrittenTranscription: handwrittenTranscription,
        evidence: evidence,
        aiAnalysis: aiAnalysisResult
    };
    
    try {
        const response = await fetch('/api/observations', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(observationData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            fieldworkObservations.push(result.observation);
            displayFieldworkRequirements();
            updateFieldworkStats();
            
            // Reset the form after successful save
            resetObservationForm();
            
            // Refresh saved observations list
            renderSavedObservations();
            
            alert(`✓ Observation saved successfully and linked to ${currentRequirements.length} requirement(s)!`);
        } else {
            alert('Failed to save: ' + result.error);
        }
    } catch (error) {
        alert('Error saving: ' + error.message);
    }
}

function cancelObservation() {
    // Reset the observation form
    resetObservationForm();
}

async function loadFieldworkObservations() {
    try {
        const response = await fetch('/api/observations');
        const result = await response.json();
        if (result.success) {
            fieldworkObservations = result.observations;
            updateFieldworkStats();
            renderSavedObservations();  // Also render in the list
        }
    } catch (error) {
        console.error('Error loading observations:', error);
    }
}

// Toggle observation form visibility
function toggleObservationForm() {
    const formContent = document.getElementById('observationFormContent');
    const toggleIcon = document.getElementById('formToggleIcon');
    
    if (formContent.classList.contains('hidden')) {
        formContent.classList.remove('hidden');
        toggleIcon.style.transform = 'rotate(0deg)';
    } else {
        formContent.classList.add('hidden');
        toggleIcon.style.transform = 'rotate(-90deg)';
    }
}

// Render all saved observations
function renderSavedObservations() {
    const container = document.getElementById('savedObservationsList');
    const countElement = document.getElementById('savedObsCount');
    
    countElement.textContent = fieldworkObservations.length;
    
    if (fieldworkObservations.length === 0) {
        container.innerHTML = `
            <div class="text-center text-slate-500 py-8">
                <p class="text-sm">No observations saved yet.</p>
                <p class="text-xs mt-2">Complete the form above to create your first observation.</p>
            </div>
        `;
        return;
    }
    
    // Sort by timestamp (newest first)
    const sortedObs = [...fieldworkObservations].sort((a, b) => {
        return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
    });
    
    container.innerHTML = sortedObs.map(obs => createObservationDetailCard(obs)).join('');
}

// Create detailed observation card
function createObservationDetailCard(obs) {
    const statusColors = {
        'compliant': { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-800', badge: 'bg-green-100 text-green-800', icon: '✓' },
        'gap': { bg: 'bg-amber-50', border: 'border-amber-300', text: 'text-amber-800', badge: 'bg-amber-100 text-amber-800', icon: '⚠️' },
        'non-compliant': { bg: 'bg-red-50', border: 'border-red-300', text: 'text-red-800', badge: 'bg-red-100 text-red-800', icon: '✗' }
    };
    
    const severityColors = {
        'minor': 'bg-slate-100 text-slate-700',
        'major': 'bg-orange-100 text-orange-700',
        'critical': 'bg-red-100 text-red-700'
    };
    
    const colors = statusColors[obs.complianceStatus] || statusColors['gap'];
    const severityClass = severityColors[obs.severity] || severityColors['major'];
    
    // Extract linked requirements with full details
    const requirements = obs.linkedRequirements || (obs.linkedRequirement ? [obs.linkedRequirement] : []);
    const requirementsText = requirements.map(req => {
        const reqText = req['requirement_text (verbatim)'] || req.requirement_text || '';
        const citation = req.citation || extractCitation(reqText) || 'Unknown';
        const auditFocus = req.suggested_audit_focus || req.auditFocus || '';
        
        return `<div class="text-xs p-3 bg-white rounded border border-purple-200 mb-2">
            <div class="flex items-center gap-2 mb-1">
                <span class="font-bold text-purple-700">${req.id}</span>
                <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-semibold">${citation}</span>
            </div>
            ${reqText ? `<div class="text-xs text-slate-600 mt-1 line-clamp-2">${cleanRequirementText(reqText)}</div>` : ''}
            ${auditFocus ? `<div class="text-xs text-purple-600 mt-1">🎯 ${auditFocus}</div>` : ''}
        </div>`;
    }).join('');
    
    // Extract evidence details
    const hasPhotos = obs.evidence && obs.evidence.filter(e => e.type === 'photo').length > 0;
    const hasAudio = obs.evidence && obs.evidence.filter(e => e.type === 'audio').length > 0;
    const hasDocuments = obs.evidence && obs.evidence.filter(e => e.type === 'document').length > 0;
    
    // AI Analysis details
    const aiAnalysis = obs.aiAnalysis || {};
    const aiInsights = aiAnalysis.key_findings || aiAnalysis.keyFindings || '';
    const aiRecommendations = aiAnalysis.recommendations || '';
    
    return `
        <div class="border-2 ${colors.border} ${colors.bg} rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
            <!-- Collapsible Header -->
            <div class="bg-white border-b ${colors.border} p-3 cursor-pointer" onclick="toggleObservationCard('${obs.id}')">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <svg id="obsToggleIcon-${obs.id}" class="w-4 h-4 transition-transform text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <span class="px-2 py-1 rounded text-xs font-bold ${colors.badge}">
                                ${colors.icon} ${obs.complianceStatus.replace('-', ' ').toUpperCase()}
                            </span>
                            <span class="px-2 py-1 rounded text-xs font-bold ${severityClass}">
                                ${obs.severity.toUpperCase()}
                            </span>
                        </div>
                        <div class="text-xs text-slate-600 flex items-center gap-3 mt-2">
                            ${obs.metadata?.location ? `<span>📍 ${obs.metadata.location}</span>` : ''}
                            ${obs.metadata?.interviewed ? `<span>👥 ${obs.metadata.interviewed}</span>` : ''}
                            <span>🕒 ${new Date(obs.timestamp).toLocaleString()}</span>
                        </div>
                        ${requirements.length > 0 ? `
                        <div class="text-xs text-purple-700 mt-2">
                            🔗 ${requirements.length} requirement(s): ${requirements.map(r => r.citation || extractCitation(r['requirement_text (verbatim)'] || '')).filter(c => c).join(', ')}
                        </div>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); openObservationModal('${obs.id}')" class="text-blue-500 hover:text-blue-700 text-sm" title="View Full Details">
                            👁️
                        </button>
                        <button onclick="event.stopPropagation(); deleteObservation('${obs.id}')" class="text-red-500 hover:text-red-700 text-sm" title="Delete">
                            🗑️
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Content -->
            <div id="obsContent-${obs.id}" class="hidden p-4">
                <div class="mb-3">
                    <div class="font-semibold text-sm ${colors.text} mb-1">Observation:</div>
                    <div class="text-sm text-slate-700 whitespace-pre-wrap bg-white p-3 rounded border border-slate-200">
                        ${obs.observationText}
                    </div>
                </div>
                
                <!-- Linked Requirements -->
                ${requirements.length > 0 ? `
                <div class="mb-3">
                    <div class="font-semibold text-xs text-purple-800 mb-2">
                        🔗 Linked Requirements (${requirements.length}):
                    </div>
                    <div class="space-y-1">
                        ${requirementsText}
                    </div>
                </div>
                ` : ''}
                
                <!-- Evidence Indicators -->
                ${hasPhotos || hasAudio || hasDocuments ? `
                <div class="mb-3">
                    <div class="font-semibold text-xs text-slate-700 mb-2">📎 Evidence:</div>
                    <div class="flex gap-2 flex-wrap">
                        ${hasPhotos ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">📸 Photos</span>' : ''}
                        ${hasAudio ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">🎤 Audio</span>' : ''}
                        ${hasDocuments ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">📄 Documents</span>' : ''}
                    </div>
                </div>
                ` : ''}
                
                <!-- AI Analysis -->
                ${aiInsights ? `
                <div class="mb-3">
                    <div class="font-semibold text-xs text-blue-800 mb-2">💡 AI Insights:</div>
                    <div class="text-xs text-blue-700 bg-blue-50 p-2 rounded border border-blue-200">
                        ${aiInsights}
                    </div>
                </div>
                ` : ''}
                
                ${aiRecommendations ? `
                <div>
                    <div class="font-semibold text-xs text-green-800 mb-2">✅ AI Recommendations:</div>
                    <div class="text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                        ${aiRecommendations}
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Refresh saved observations
async function refreshSavedObservations() {
    await loadFieldworkObservations();
}

// Toggle observation card visibility
function toggleObservationCard(obsId) {
    const content = document.getElementById(`obsContent-${obsId}`);
    const icon = document.getElementById(`obsToggleIcon-${obsId}`);
    
    if (content && icon) {
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }
}

// Delete observation
async function deleteObservation(observationId) {
    if (!confirm('Are you sure you want to delete this observation?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/observations/${observationId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove from local array
            fieldworkObservations = fieldworkObservations.filter(obs => obs.id !== observationId);
            renderSavedObservations();
            displayFieldworkRequirements();
            updateFieldworkStats();
            alert('✓ Observation deleted successfully');
        } else {
            alert('Failed to delete: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting observation: ' + error.message);
    }
}

// Open observation detail modal
function openObservationModal(observationId) {
    const observation = fieldworkObservations.find(obs => obs.id === observationId);
    if (!observation) {
        console.error('Observation not found:', observationId);
        return;
    }
    
    const modalContent = document.getElementById('observationModalContent');
    modalContent.innerHTML = renderFullObservationDetails(observation);
    
    document.getElementById('observationDetailModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

// Close observation detail modal
function closeObservationModal() {
    document.getElementById('observationDetailModal').classList.add('hidden');
    document.body.style.overflow = 'auto'; // Restore scrolling
}

// Render full observation details in modal
function renderFullObservationDetails(obs) {
    const statusColors = {
        'compliant': { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-800', badge: 'bg-green-100 text-green-800', icon: '✓' },
        'gap': { bg: 'bg-amber-50', border: 'border-amber-300', text: 'text-amber-800', badge: 'bg-amber-100 text-amber-800', icon: '⚠️' },
        'non-compliant': { bg: 'bg-red-50', border: 'border-red-300', text: 'text-red-800', badge: 'bg-red-100 text-red-800', icon: '✗' }
    };
    
    const severityColors = {
        'minor': 'bg-slate-100 text-slate-700',
        'major': 'bg-orange-100 text-orange-700',
        'critical': 'bg-red-100 text-red-700'
    };
    
    const colors = statusColors[obs.complianceStatus] || statusColors['gap'];
    const severityClass = severityColors[obs.severity] || severityColors['major'];
    
    // Extract linked requirements
    const requirements = obs.linkedRequirements || (obs.linkedRequirement ? [obs.linkedRequirement] : []);
    
    // AI Analysis details
    const aiAnalysis = obs.aiAnalysis || {};
    const aiInsights = aiAnalysis.key_findings || aiAnalysis.keyFindings || '';
    const aiRecommendations = aiAnalysis.recommendations || '';
    const visualFindings = aiAnalysis.visual_findings || '';
    const suggestedObsText = aiAnalysis.suggested_observation_text || '';
    
    // Evidence details
    const photos = obs.evidence?.filter(e => e.type === 'photo') || [];
    const audioFiles = obs.evidence?.filter(e => e.type === 'audio') || [];
    const documents = obs.evidence?.filter(e => e.type === 'document') || [];
    
    return `
        <div class="space-y-6">
            <!-- Status Summary -->
            <div class="flex items-center gap-3 flex-wrap">
                <span class="px-4 py-2 rounded-lg text-sm font-bold ${colors.badge}">
                    ${colors.icon} ${obs.complianceStatus.replace('-', ' ').toUpperCase()}
                </span>
                <span class="px-4 py-2 rounded-lg text-sm font-bold ${severityClass}">
                    ${obs.severity.toUpperCase()}
                </span>
                <span class="text-sm text-slate-600">
                    🕒 ${new Date(obs.timestamp).toLocaleString()}
                </span>
            </div>
            
            <!-- Metadata -->
            ${obs.metadata?.location || obs.metadata?.interviewed ? `
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <h3 class="font-bold text-sm text-slate-700 mb-2">📍 Location & People</h3>
                <div class="grid grid-cols-2 gap-4">
                    ${obs.metadata.location ? `
                    <div>
                        <div class="text-xs text-slate-500 mb-1">Location</div>
                        <div class="text-sm font-medium">${obs.metadata.location}</div>
                    </div>
                    ` : ''}
                    ${obs.metadata.interviewed ? `
                    <div>
                        <div class="text-xs text-slate-500 mb-1">Interviewed</div>
                        <div class="text-sm font-medium">${obs.metadata.interviewed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}
            
            <!-- Observation Text -->
            <div class="bg-white rounded-lg p-4 border-2 ${colors.border}">
                <h3 class="font-bold text-sm ${colors.text} mb-3">📝 Observation</h3>
                <div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">
                    ${obs.observationText}
                </div>
            </div>
            
            <!-- Photos -->
            ${photos.length > 0 ? `
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <h3 class="font-bold text-sm text-blue-800 mb-3">📸 Photos (${photos.length})</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    ${photos.map((photo, index) => `
                        <div class="relative group">
                            <img src="${photo.url || 'https://placehold.co/300x200/3B82F6/FFFFFF?text=Photo+' + (index + 1)}" 
                                 alt="Evidence photo ${index + 1}" 
                                 class="w-full h-40 object-cover rounded-lg border-2 border-blue-300">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-opacity rounded-lg flex items-center justify-center">
                                <button onclick="window.open('${photo.url}', '_blank')" class="opacity-0 group-hover:opacity-100 px-3 py-1 bg-white text-blue-600 rounded text-xs font-semibold">
                                    View Full Size
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${obs.metadata?.imageDescription ? `
                <div class="mt-3 p-3 bg-white rounded border border-blue-200">
                    <div class="text-xs font-semibold text-blue-700 mb-1">Photo Description:</div>
                    <div class="text-sm text-blue-900">${obs.metadata.imageDescription}</div>
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            <!-- Audio -->
            ${audioFiles.length > 0 || obs.metadata?.audioTranscription ? `
            <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                <h3 class="font-bold text-sm text-purple-800 mb-3">🎤 Audio Evidence</h3>
                ${audioFiles.map((audio, index) => `
                    <div class="mb-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs text-purple-600 font-medium">Recording ${index + 1}</span>
                            ${audio.duration ? `<span class="text-xs text-purple-500">(${audio.duration})</span>` : ''}
                        </div>
                        <audio controls class="w-full h-10" src="${audio.url}">
                            Your browser does not support the audio element.
                        </audio>
                        ${audio.transcription ? `
                        <div class="mt-2 p-2 bg-white rounded border border-purple-200">
                            <div class="text-xs font-semibold text-purple-700 mb-1">📝 Transcription:</div>
                            <div class="text-xs text-purple-900 whitespace-pre-wrap">${audio.transcription}</div>
                        </div>
                        ` : ''}
                    </div>
                `).join('')}
                ${obs.metadata?.audioTranscription && audioFiles.length === 0 ? `
                <div class="p-3 bg-white rounded border border-purple-200">
                    <div class="text-xs font-semibold text-purple-700 mb-2">📝 Transcription:</div>
                    <div class="text-sm text-purple-900 whitespace-pre-wrap">${obs.metadata.audioTranscription}</div>
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            <!-- Handwritten Notes -->
            ${obs.metadata?.handwrittenTranscription ? `
            <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                <h3 class="font-bold text-sm text-orange-800 mb-3">✍️ Handwritten Notes Transcription</h3>
                <div class="p-3 bg-white rounded border border-orange-200">
                    <div class="text-sm text-orange-900 whitespace-pre-wrap">${obs.metadata.handwrittenTranscription}</div>
                </div>
            </div>
            ` : ''}
            
            <!-- Documents -->
            ${documents.length > 0 ? `
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <h3 class="font-bold text-sm text-green-800 mb-3">📄 Documents (${documents.length})</h3>
                <div class="space-y-2">
                    ${documents.map(doc => `
                        <div class="flex items-center justify-between p-2 bg-white rounded border border-green-200">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">📄</span>
                                <div>
                                    <div class="text-sm font-medium">${doc.name || 'Document'}</div>
                                    ${doc.size ? `<div class="text-xs text-slate-500">${typeof doc.size === 'number' ? (doc.size / 1024).toFixed(1) + ' KB' : doc.size}</div>` : ''}
                                </div>
                            </div>
                            ${doc.url ? `<button onclick="window.open('${doc.url}', '_blank')" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">View</button>` : '<span class="text-xs text-slate-500">Saved</span>'}
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Linked Requirements -->
            ${requirements.length > 0 ? `
            <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                <h3 class="font-bold text-sm text-purple-800 mb-3">🔗 Linked Requirements (${requirements.length})</h3>
                <div class="space-y-3">
                    ${requirements.map(req => {
                        const reqText = req['requirement_text (verbatim)'] || req.requirement_text || '';
                        const citation = req.citation || extractCitation(reqText) || 'Unknown';
                        const cleanedText = cleanRequirementText(reqText);
                        const focusAreas = req.suggested_audit_focus || req.auditFocus || '';
                        
                        return `
                        <div class="bg-white rounded-lg p-3 border-2 border-purple-300">
                            <div class="flex items-start gap-3 mb-2">
                                <span class="px-2 py-1 bg-purple-600 text-white rounded text-xs font-bold">${req.id}</span>
                                <div class="flex-1">
                                    <div class="text-xs font-semibold text-purple-600 mb-1">${citation}</div>
                                    <div class="text-xs text-purple-900">${cleanedText}</div>
                                </div>
                            </div>
                            ${focusAreas ? `
                            <div class="mt-2 pt-2 border-t border-purple-200">
                                <div class="text-xs font-semibold text-purple-700 mb-1">🎯 Audit Focus:</div>
                                <div class="text-xs text-purple-800">${focusAreas}</div>
                            </div>
                            ` : ''}
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- AI Analysis -->
            ${aiInsights || visualFindings || aiRecommendations || suggestedObsText ? `
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <h3 class="font-bold text-sm text-blue-800 mb-3">🤖 AI Analysis</h3>
                
                ${aiInsights ? `
                <div class="mb-3">
                    <div class="text-xs font-semibold text-blue-700 mb-2">💡 Key Findings:</div>
                    <div class="text-sm text-blue-900 bg-white p-3 rounded border border-blue-200 whitespace-pre-wrap">
                        ${aiInsights}
                    </div>
                </div>
                ` : ''}
                
                ${visualFindings ? `
                <div class="mb-3">
                    <div class="text-xs font-semibold text-blue-700 mb-2">👁️ Visual Analysis:</div>
                    <div class="text-sm text-blue-900 bg-white p-3 rounded border border-blue-200 whitespace-pre-wrap">
                        ${visualFindings}
                    </div>
                </div>
                ` : ''}
                
                ${aiRecommendations ? `
                <div class="mb-3">
                    <div class="text-xs font-semibold text-green-700 mb-2">✅ Recommendations:</div>
                    <div class="text-sm text-green-900 bg-white p-3 rounded border border-green-200 whitespace-pre-wrap">
                        ${aiRecommendations}
                    </div>
                </div>
                ` : ''}
                
                ${suggestedObsText ? `
                <div>
                    <div class="text-xs font-semibold text-amber-700 mb-2">✨ AI-Suggested Observation Text:</div>
                    <div class="text-sm text-amber-900 bg-white p-3 rounded border border-amber-200 whitespace-pre-wrap">
                        ${suggestedObsText}
                    </div>
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            <!-- Actions -->
            <div class="flex gap-3 pt-4 border-t border-slate-200">
                <button onclick="closeObservationModal()" class="flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg font-semibold hover:bg-slate-300">
                    Close
                </button>
                <button onclick="event.stopPropagation(); closeObservationModal(); deleteObservation('${obs.id}')" class="px-4 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600">
                    🗑️ Delete
                </button>
            </div>
        </div>
    `;
}

function updateFieldworkStats() {
    document.getElementById('reqCountFieldwork').innerText = fieldworkRequirements.length;
    document.getElementById('obsCountFieldwork').innerText = fieldworkObservations.length;
    
    const gaps = fieldworkObservations.filter(obs => 
        obs.complianceStatus === 'gap' || obs.complianceStatus === 'non-compliant'
    ).length;
    document.getElementById('gapCountFieldwork').innerText = gaps;
}

function filterFieldworkRequirements(level) {
    document.querySelectorAll('.filter-fieldwork-btn').forEach(btn => {
        btn.classList.remove('bg-slate-700', 'text-white');
        btn.classList.add('bg-slate-200', 'text-slate-700');
    });
    event.target.classList.add('bg-slate-700', 'text-white');
    event.target.classList.remove('bg-slate-200', 'text-slate-700');
    displayFieldworkRequirements();
}

function searchFieldworkRequirements() {
    displayFieldworkRequirements();
}

// Initialize on tab switch
function initializeFieldwork() {
    loadFieldworkRequirements();
}

    </script>
</body>
</html>

